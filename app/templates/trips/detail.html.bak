{% extends "base.html" %}

{% block title %}{{ trip.name }} - MotoTrip{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen font-sans">

    <!-- HERO SECTION -->
    <div class="relative h-[60vh] md:h-[70vh] w-full overflow-hidden">
        <!-- Background Image -->
        {% if trip.coverImage %}
        <div class="absolute inset-0 bg-cover bg-center transition-transform duration-1000 hover:scale-105"
            style="background-image: url('{{ trip.coverImage }}');">
        </div>
        {% elif trip.photos and trip.photos|length > 0 %}
        <div class="absolute inset-0 bg-cover bg-center transition-transform duration-1000 hover:scale-105"
            style="background-image: url('{{ trip.photos[0] }}');">
        </div>
        {% else %}
        <div class="absolute inset-0 bg-gradient-to-r from-gray-800 to-gray-900"></div>
        {% endif %}

        <!-- Overlay & Content -->
        <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/40 to-transparent"></div>

        <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 text-white z-10">
            <div class="max-w-7xl mx-auto">
                <div
                    class="inline-flex items-center px-3 py-1 rounded-full border border-white/30 bg-white/10 backdrop-blur-md mb-4 animate-fade-in-up">
                    <span class="mr-2 text-yellow-400 text-lg">★</span>
                    <span class="text-sm font-medium tracking-wide uppercase">Voyage Moto Premium</span>
                </div>

                <h1 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight shadow-sm">{{ trip.name }}</h1>

                <div class="flex flex-wrap gap-6 text-lg md:text-xl font-light text-gray-200">
                    {% if trip.region %}
                    <div class="flex items-center">
                        <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>
                        {{ trip.region }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- STATS BAR (Floating) -->
    <div class="relative -mt-10 z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-xl shadow-xl grid grid-cols-2 md:grid-cols-4 divide-x divide-gray-100 p-4 md:p-6 animate-fade-in-up"
            style="animation-delay: 0.1s;">
            <!-- Duration -->
            <div class="flex flex-col items-center justify-center p-2 text-center">
                <div class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-1">Durée</div>
                <div class="text-2xl md:text-3xl font-bold text-gray-900">
                    {% if trip.days %}
                    {{ trip.days|length }} Jours
                    <span class="text-sm font-normal text-gray-500 block text-xs">
                        {{ (trip.days|length) - 1 }} Nuits
                    </span>
                    {% else %}
                    -
                    {% endif %}
                </div>
            </div>

            <!-- Distance -->
            <div class="flex flex-col items-center justify-center p-2 text-center">
                <div class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-1">Distance</div>
                <div class="text-2xl md:text-3xl font-bold text-gray-900">
                    {{ trip.totalDistance|int }} <span class="text-lg text-gray-500 font-normal">km</span>
                </div>
            </div>



            <!-- Level -->
            <div class="flex flex-col items-center justify-center p-2 text-center col-span-2 md:col-span-1">
                <div class="text-gray-400 text-sm font-medium uppercase tracking-wider mb-1">Niveau</div>
                <div class="flex items-center justify-center text-yellow-500 text-xl">
                    {% set diff = trip.difficultyLevel or 3 %}
                    {% for i in range(5) %}
                    {% if i < diff %} <i class="fas fa-star"></i>
                        {% else %}
                        <i class="far fa-star text-gray-300"></i>
                        {% endif %}
                        {% endfor %}
                </div>
                <span class="text-xs text-gray-500 mt-1">
                    {% if diff == 1 %}Débutant{% elif diff == 2 %}Facile{% elif diff == 3 %}Intermédiaire{% elif diff ==
                    4 %}Difficile{% elif diff == 5 %}Expert{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

            <!-- LEFT COLUMN (Content) -->
            <div class="lg:col-span-2 space-y-12">

                <!-- About -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
                        <span class="bg-indigo-600 w-2 h-8 mr-4 rounded-full"></span>
                        L'expérience
                    </h2>
                    <div class="prose prose-lg text-gray-600 leading-relaxed">
                        {% if trip.description %}
                        {{ trip.description|safe }}
                        {% else %}
                        <p class="italic text-gray-400">Description à venir...</p>
                        {% endif %}
                    </div>
                </section>

                <!-- Highlights -->
                {% if trip.highlights %}
                <section>
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Points Forts</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for highlight in trip.highlights %}
                        <div
                            class="flex items-start bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <div class="flex-shrink-0 bg-green-100 rounded-full p-1 mr-3">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                            </div>
                            <span class="text-gray-700 font-medium">{{ highlight }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <!-- Itinerary Teaser -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
                        <span class="bg-indigo-600 w-2 h-8 mr-4 rounded-full"></span>
                        Votre Itinéraire
                    </h2>

                    <div class="relative border-l-2 border-indigo-100 ml-3 space-y-8 py-2">
                        {% for day in trip.days %}
                        <div class="relative pl-8">
                            <!-- Timeline Dot -->
                            <div
                                class="absolute -left-[9px] top-1 w-5 h-5 bg-white border-4 border-indigo-500 rounded-full">
                            </div>

                            <h3 class="text-xl font-bold text-gray-900 mb-1">Jour {{ loop.index }} : {{ day.distance }}
                                km</h3>

                            <div class="flex flex-wrap gap-3 text-sm text-gray-500 mb-3">
                                <!-- POIs only, no city/elevation -->
                            </div>

                            <!-- POIs Preview -->
                            {% if day.pois and day.pois|length > 0 %}
                            <div class="flex flex-wrap gap-2 mt-2">
                                {% for poi in day.pois[:3] %}
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-50 text-purple-700 border border-purple-100">
                                    {{ poi.name }}
                                </span>
                                {% endfor %}
                                {% if day.pois|length > 3 %}
                                <span class="text-xs text-gray-400 self-center">+{{ day.pois|length - 3 }} autres</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- POI Gallery (Horizontal Scroll) -->
                <section>
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
                        <span class="bg-indigo-600 w-2 h-8 mr-4 rounded-full"></span>
                        Galerie
                    </h2>

                    {% if trip.photos %}
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {% for photo in trip.photos[:6] %}
                        <div
                            class="aspect-video rounded-lg overflow-hidden bg-gray-200 shadow-sm group relative cursor-pointer">
                            <img src="{{ photo }}" alt="Photo voyage"
                                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 italic">Aucune photo disponible pour le moment.</p>
                    {% endif %}
                </section>
            </div>


            <!-- RIGHT COLUMN (Sidebar) -->
            <div class="lg:col-span-1">
                <div class="sticky top-24 space-y-6">

                    <!-- Booking Card -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                        <div class="p-6 bg-gradient-to-br from-indigo-600 to-purple-700 text-white text-center">
                            <p class="text-sm font-medium text-indigo-100 uppercase tracking-wider mb-2">Prix par
                                personne</p>
                            <div class="flex items-baseline justify-center">
                                <span class="text-5xl font-extrabold">{{ trip.pricePerPerson|int }}</span>
                                <span class="text-2xl font-medium">€</span>
                            </div>
                        </div>

                        <div class="p-6">
                            {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                            {% for category, message in messages %}
                            <div
                                class="mb-4 p-3 rounded-lg text-sm bg-{{ 'red' if category == 'error' else 'green' }}-50 text-{{ 'red' if category == 'error' else 'green' }}-700 border border-{{ 'red' if category == 'error' else 'green' }}-200">
                                {{ message }}
                            </div>
                            {% endfor %}
                            {% endif %}
                            {% endwith %}

                            <form method="POST"
                                action="{{ url_for('trips.book_trip', slug=trip.publishedSlug or trip.slug) }}"
                                id="bookingForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Dates</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="date" name="start_date" id="start_date" required
                                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                        <input type="date" name="end_date" id="end_date" required
                                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Participants</label>
                                    <select name="nb_participants" id="nb_participants"
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        {% for i in range(1, 11) %}
                                        <option value="{{ i }}">{{ i }} Pilote{{ 's' if i > 1 else '' }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" name="email" required placeholder="votre@email.com"
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </div>

                                <div class="pt-4 border-t border-gray-100">
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-gray-600">Total estimé</span>
                                        <span class="font-bold text-gray-900" id="total_price">{{
                                            trip.pricePerPerson|int }}€</span>
                                    </div>
                                    <div class="flex justify-between text-sm mb-4">
                                        <span class="text-gray-600">Acompte (30%)</span>
                                        <span class="font-bold text-indigo-600" id="deposit_price">{{
                                            (trip.pricePerPerson * 0.3)|int }}€</span>
                                    </div>
                                </div>

                                <button type="submit"
                                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    Réserver mon aventure
                                </button>

                                <p class="text-center text-xs text-gray-400 flex items-center justify-center mt-3">
                                    <i class="fas fa-lock mr-1"></i> Paiement sécurisé via Stripe
                                </p>
                            </form>
                        </div>
                    </div>

                    <!-- Unlocked Map -->
                    <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden relative group">
                        <div id="trip-map" class="relative h-96 w-full z-0"></div>

                        <!-- Leaflet CSS & JS -->
                        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
                            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
                        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

                        <script>
                            document.addEventListener('DOMContentLoaded', () => {
                                const map = L.map('trip-map').setView([46.2276, 2.2137], 6); // Default to France center

                                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                                    subdomains: 'abcd',
                                    maxZoom: 19
                                }).addTo(map);

                                // Load GPX tracks for each day
                                const gpxUrls = [
                                    {% for day in trip.days %}
                                        "{{ day.gpxUrl or '' }}",
                                {% endfor %}
                                ].filter(url => url.length > 0);

                            if (gpxUrls.length > 0) {
                                let loadedTracks = 0;
                                const bounds = L.latLngBounds([]);

                                gpxUrls.forEach((url, index) => {
                                    // Use specific colors for each day if possible, or same color
                                    const color = ['#4f46e5', '#7c3aed', '#db2777', '#dc2626', '#d97706'][index % 5];

                                    new L.GPX(url, {
                                        async: true,
                                        marker_options: {
                                            startIconUrl: null,
                                            endIconUrl: null,
                                            shadowUrl: null
                                        },
                                        polyline_options: {
                                            color: color,
                                            opacity: 0.8,
                                            weight: 4,
                                            lineCap: 'round'
                                        }
                                    }).on('loaded', function (e) {
                                        const gpx = e.target;
                                        map.fitBounds(gpx.getBounds());
                                        bounds.extend(gpx.getBounds());
                                        loadedTracks++;

                                        // Once all tracks are loaded, fit global bounds
                                        if (loadedTracks === gpxUrls.length) {
                                            map.fitBounds(bounds, { padding: [20, 20] });
                                        }
                                    });
                                }).addTo(map);
                            } else {
                                // Fallback text if no GPX
                                const container = document.getElementById('trip-map');
                                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 italic">Tracé non disponible</div>';
                            }
                            });
                        </script>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const pricePerPerson = {{ trip.pricePerPerson or 0 }
    };
    const participantsSelect = document.getElementById('nb_participants');
    const totalPriceEl = document.getElementById('total_price');
    const depositPriceEl = document.getElementById('deposit_price');

    if (participantsSelect) {
        participantsSelect.addEventListener('change', (e) => {
            const count = parseInt(e.target.value);
            const total = count * pricePerPerson;
            const deposit = total * 0.3; // 30% deposit logic

            totalPriceEl.textContent = total + '€';
            depositPriceEl.textContent = Math.round(deposit) + '€';
        });
    }

    // Min date logic
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    if (startDateInput) {
        startDateInput.min = today;
        startDateInput.addEventListener('change', function () {
            endDateInput.min = this.value;
        });
    }
});
</script>

<style>
    @keyframes fade-in-up {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fade-in-up 0.8s ease-out forwards;
    }
</style>
{% endblock %}