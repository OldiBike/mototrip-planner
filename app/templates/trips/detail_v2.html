{% extends "base.html" %}

{% block title %}{{ trip.name }} | MotoTrip Adventure{% endblock %}

{% block content %}
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;500;700&family=Inter:wght@300;400;600&display=swap"
    rel="stylesheet">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    /* Dynamic Theme Utilities */
    .text-accent {
        color: var(--color-accent) !important;
    }

    .bg-accent {
        background-color: var(--color-accent) !important;
    }

    .border-accent {
        border-color: var(--color-accent) !important;
    }

    .hover-bg-accent:hover {
        background-color: var(--color-accent-light) !important;
        filter: brightness(110%);
        box-shadow: 0 0 15px var(--color-accent-glow);
    }

    .hover-text-accent:hover {
        color: var(--color-accent-light) !important;
    }

    .hover-border-accent:hover {
        border-color: var(--color-accent-light) !important;
    }

    /* Specific Shadow Utility */
    .shadow-accent {
        box-shadow: 0 0 20px var(--color-accent-glow) !important;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #0f1115;
        color: #e5e7eb;
    }

    h1,
    h2,
    h3,
    h4,
    .font-heading {
        font-family: 'Oswald', sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Smooth Scroll */
    html {
        scroll-behavior: smooth;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #1f2937;
    }

    ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--color-accent);
    }

    /* Animations */
    .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    }

    .fade-in-up.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .reveal-text {
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        background-image: linear-gradient(90deg, #fff, #fff);
        background-size: 0% 100%;
        background-repeat: no-repeat;
        transition: background-size 1s ease-in-out;
    }

    .reveal-text.visible {
        background-size: 100% 100%;
    }

    /* Map Dark Mode Filter */
    .map-tiles-dark {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%) grayscale(20%);
    }

    /* Texture Background */
    .bg-texture {
        background-image: url("{{ url_for('static', filename='img/bg-texture.png') }}");
        background-repeat: repeat;
        background-size: 400px;
        position: relative;
    }
</style>

<div class="relative w-full overflow-hidden"
    style="--color-accent: {{ theme.main }}; --color-accent-light: {{ theme.light }}; --color-accent-dark: {{ theme.dark }}; --color-accent-glow: {{ theme.glow }}; --color-dark: #111827;">

    <!-- 1. IMMERSIVE HERO SECTION -->
    <header class="relative h-[90vh] md:h-screen w-full flex items-center justify-center overflow-hidden">
        <!-- Parallax Background -->
        <div class="absolute inset-0 z-0">
            {% if trip.headerImage or trip.coverImage %}
            <div id="hero-bg"
                class="w-full h-[120%] -mt-[10%] bg-cover bg-center transition-transform duration-75 ease-out will-change-transform"
                style="background-image: url('{{ trip.headerImage or trip.coverImage }}');">
            </div>
            {% else %}
            <div class="w-full h-full bg-gradient-to-br from-gray-900 to-black"></div>
            {% endif %}
            <div class="absolute inset-0 bg-gradient-to-t from-[#0f1115] via-black/40 to-black/30"></div>
        </div>

        <!-- Hero Content -->
        <div
            class="relative z-10 inline-flex flex-col items-center text-center px-8 py-10 max-w-4xl mx-auto mt-16 bg-black/30 backdrop-blur-sm rounded-3xl border border-white/10 shadow-2xl">
            <!-- Logo -->
            <div class="mb-8 animate-fade-in-up">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="OldiBike Police Logo"
                    class="h-20 md:h-24 mx-auto drop-shadow-2xl">
            </div>

            <h1 class="text-5xl md:text-8xl font-bold text-white mb-6 drop-shadow-2xl leading-tight">
                {{ trip.name }}
            </h1>

            <div
                class="flex flex-wrap justify-center gap-4 text-gray-300 font-light text-lg md:text-xl tracking-wide mb-10">
                {% if trip.region %}
                <span class="flex items-center"><i class="fas fa-map-marker-alt text-accent mr-2"></i> {{ trip.region
                    }}</span>
                <span class="text-gray-600 hidden md:inline">•</span>
                {% endif %}
                <span class="flex items-center"><i class="fas fa-calendar-alt text-accent mr-2"></i>
                    {% set ns = namespace(total=0) %}
                    {% if trip.days %}{% for day in trip.days %}{% set ns.total = ns.total + (day.nights|default(1)|int)
                    %}{% endfor %}{% endif %}
                    {{ ns.total }} Jours</span>
                <span class="text-gray-600 hidden md:inline">•</span>
                <span class="flex items-center"><i class="fas fa-road text-accent mr-2"></i> {{ trip.totalDistance|int
                    }} km</span>
            </div>

            <a href="#booking"
                class="inline-flex items-center justify-center px-8 py-4 bg-accent text-black font-bold text-lg uppercase tracking-wider rounded transition-all hover-bg-accent hover:scale-105 shadow-accent transform">
                Réserver Maintenant
            </a>
        </div>

        <div
            class="absolute bottom-10 left-1/2 transform -translate-x-1/2 flex flex-col items-center animate-bounce text-gray-400">
            <span class="text-xs uppercase tracking-widest mb-2">Explorer</span>
            <i class="fas fa-chevron-down"></i>
        </div>
    </header>

    <!-- 2. STATS STRIP -->
    <div class="relative z-20 -mt-20 md:-mt-24 px-4 max-w-6xl mx-auto mb-20">
        <div
            class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-800/60 backdrop-blur-xl border border-gray-700/50 rounded-2xl p-6 shadow-2xl">
            <div class="flex flex-col items-center justify-center border-r border-gray-600/30">
                <span class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Niveau</span>
                <div class="flex text-accent text-lg">
                    {% set diff = trip.difficultyLevel or 3 %}
                    {% for i in range(5) %}
                    {% if i < diff %}<i class="fas fa-star"></i>{% else %}<i class="far fa-star text-gray-600"></i>{%
                        endif %}
                        {% endfor %}
                </div>
            </div>
            <div class="flex flex-col items-center justify-center border-r border-gray-600/30">
                <span class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Distance Totale</span>
                <span class="text-2xl md:text-3xl font-heading font-bold text-white">{{ trip.totalDistance|int }} <span
                        class="text-sm font-normal text-gray-500">km</span></span>
            </div>
            <div class="flex flex-col items-center justify-center border-r border-gray-600/30">
                <span class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Période</span>
                <span class="text-xl md:text-2xl font-heading font-bold text-white uppercase text-center">
                    {% if trip.recommendedRequestStart and trip.recommendedRequestEnd %}
                    {% set start_month = trip.recommendedRequestStart.split('-')[1] %}
                    {% set end_month = trip.recommendedRequestEnd.split('-')[1] %}
                    {% set months = {'01':'JAN', '02':'FÉV', '03':'MAR', '04':'AVR', '05':'MAI', '06':'JUIN',
                    '07':'JUIL', '08':'AOÛT', '09':'SEPT', '10':'OCT', '11':'NOV', '12':'DÉC'} %}
                    {{ months[start_month] }} - {{ months[end_month] }}
                    {% else %}
                    <span class="text-lg">Toute l'année</span>
                    {% endif %}
                </span>
            </div>
            <div class="flex flex-col items-center justify-center">
                <span class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">À partir de</span>
                <span class="text-2xl md:text-3xl font-heading font-bold text-accent">{{ trip.pricePerPerson |
                    default(0) }}€</span>
            </div>
        </div>
    </div>

    <!-- 3. THE EXPERIENCE -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-16 gap-12 grid grid-cols-1 lg:grid-cols-12 items-stretch"
        style="min-height: 500px;">
        <div class="lg:col-span-7 prose prose-invert prose-lg scroll-element fade-in-up break-words">
            <h2 class="text-4xl text-white mb-8 border-l-4 border-accent pl-6">L'Expérience</h2>
            <div class="text-gray-300 leading-relaxed text-lg overflow-hidden">
                {% if trip.description %}
                {{ trip.description|safe }}
                {% else %}
                <p>Préparez-vous pour une aventure inoubliable...</p>
                {% endif %}
            </div>
        </div>

        <div class="lg:col-span-5 relative rounded-2xl overflow-hidden shadow-2xl min-h-[400px] flex flex-col scroll-element fade-in-up"
            style="transition-delay: 0.2s;">
            <div id="poi-slideshow" class="absolute inset-0 z-0">
                {% set all_poi_photos = [] %}
                {% for day in trip.days %}
                {% if day.poi_objects %}
                {% for poi in day.poi_objects %}
                {% if poi.photos %}{% for photo in poi.photos %}{% set _ = all_poi_photos.append(photo) %}{% endfor %}{%
                endif %}
                {% endfor %}
                {% endif %}
                {% endfor %}

                {% if all_poi_photos %}
                {% for photo in all_poi_photos %}
                <img src="{{ photo }}"
                    class="absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ease-in-out {% if loop.first %}opacity-100{% else %}opacity-0{% endif %} slideshow-img">
                {% endfor %}
                {% else %}
                <img src="{{ trip.coverImage }}" class="absolute inset-0 w-full h-full object-cover opacity-50">
                {% endif %}
            </div>
            <div class="absolute inset-0 bg-black/70 z-10"></div>

            <div class="relative z-20 p-8 flex flex-col h-full">
                <h3 class="text-2xl text-accent font-heading mb-6 tracking-wide border-b border-accent/30 pb-4">Points
                    Forts</h3>
                <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar space-y-4">
                    {% if trip.highlights %}
                    {% for highlight in trip.highlights %}
                    <div class="flex items-start group">
                        <i class="fas fa-star text-accent mt-1 mr-3 group-hover:scale-110 transition-transform"></i>
                        <p class="text-gray-200 font-medium group-hover:text-white transition-colors">{{ highlight }}
                        </p>
                    </div>
                    {% endfor %}
                    {% endif %}

                    {% set displayed_pois = [] %}
                    {% for day in trip.days %}
                    {% if day.poi_objects %}
                    {% for poi in day.poi_objects %}
                    {% if poi.name not in displayed_pois %}
                    <div class="flex items-start group">
                        <i
                            class="fas fa-map-marker-alt text-accent mt-1 mr-3 group-hover:scale-110 transition-transform"></i>
                        <div>
                            <p class="text-white font-bold group-hover:text-accent transition-colors">{{ poi.name }}</p>
                            {% if poi.category %}<span class="text-xs text-gray-400 capitalize">{{ poi.category
                                }}</span>{% endif %}
                        </div>
                    </div>
                    {% set _ = displayed_pois.append(poi.name) %}
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const images = document.querySelectorAll('.slideshow-img');
            if (images.length > 1) {
                let currentIndex = 0;
                setInterval(() => {
                    images[currentIndex].classList.remove('opacity-100');
                    images[currentIndex].classList.add('opacity-0');
                    currentIndex = (currentIndex + 1) % images.length;
                    images[currentIndex].classList.remove('opacity-0');
                    images[currentIndex].classList.add('opacity-100');
                }, 4000);
            }
        });
    </script>

    <!-- 4. DYNAMIC MAP SECTION -->
    <section class="w-full bg-gray-900 border-y border-gray-800 p-4 md:p-0">
        <div
            class="relative h-[500px] md:h-[600px] w-full rounded-2xl md:rounded-none overflow-hidden shadow-2xl md:shadow-none bg-gray-800">
            <div id="trip-map" class="w-full h-full z-10"></div>
            <div
                class="absolute bottom-6 left-6 z-20 bg-gray-900/90 backdrop-blur px-4 py-2 rounded-lg border border-gray-700 pointer-events-none">
                <span class="text-white text-sm font-bold flex items-center"><i
                        class="fas fa-info-circle mr-2 text-accent"></i> Tracé approximatif (sécurité)</span>
            </div>
        </div>
    </section>

    <!-- 5. ITINERARY -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-12">
        <h2 class="text-4xl text-center text-white mb-16 font-heading"><span class="text-accent">Votre</span> Itinéraire
        </h2>
        <div class="relative">
            <!-- Vertical Line -->
            <div class="absolute left-4 md:left-1/2 top-0 bottom-0 w-1 bg-gray-700 transform -translate-x-1/2 z-0">
            </div>

            <div class="space-y-16">
                {% set ns = namespace(counter=1) %}
                {% for day in trip.days %}

                <div class="relative flex flex-col md:flex-row items-center scroll-element fade-in-up">
                    <div
                        class="absolute left-4 md:left-1/2 w-8 h-8 rounded-full bg-black border-4 border-accent transform -translate-x-1/2 flex items-center justify-center z-10 shadow-accent">
                        <span class="text-[10px] font-bold text-white">{{ ns.counter }}</span>
                    </div>

                    <div
                        class="md:w-1/2 w-full pl-12 md:pl-0 md:pr-12 md:text-right content-left {% if ns.counter is even %}md:order-1{% else %}md:order-1{% endif %}">
                        {% if ns.counter is odd %}
                        <div
                            class="bg-gray-800/80 backdrop-blur-md p-6 rounded-xl border border-gray-700 hover:border-accent/50 transition-all shadow-xl md:mr-10 md:ml-auto group">
                            <h3 class="text-2xl text-white font-heading mb-2">Jour {{ ns.counter }}</h3>
                            <div class="text-accent font-bold text-sm mb-4 tracking-wider">{{ day.distance }} KM</div>
                            <div class="flex flex-wrap gap-2 justify-end">
                                {% if day.pois %}{% for poi in day.pois[:2] %}<span
                                    class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded group-hover:bg-accent group-hover:text-black transition-colors">{{
                                    poi.name }}</span>{% endfor %}{% endif %}
                            </div>
                        </div>
                        {% else %} <div class="hidden md:block"></div> {% endif %}
                    </div>

                    <div
                        class="md:w-1/2 w-full pl-12 md:pl-12 content-right {% if ns.counter is even %}md:order-2{% else %}md:order-2{% endif %}">
                        {% if ns.counter is even %}
                        <div
                            class="bg-gray-800/80 backdrop-blur-md p-6 rounded-xl border border-gray-700 hover:border-accent/50 transition-all shadow-xl md:ml-10 group">
                            <h3 class="text-2xl text-white font-heading mb-2">Jour {{ ns.counter }}</h3>
                            <div class="text-accent font-bold text-sm mb-4 tracking-wider">{{ day.distance }} KM</div>
                            <div class="flex flex-wrap gap-2">
                                {% if day.pois %}{% for poi in day.pois[:2] %}<span
                                    class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded group-hover:bg-accent group-hover:text-black transition-colors">{{
                                    poi.name }}</span>{% endfor %}{% endif %}
                            </div>
                        </div>
                        {% else %} <div class="hidden md:block"></div> {% endif %}
                    </div>
                </div>
                {% set ns.counter = ns.counter + 1 %}

                <!-- DAY OFF LOGIC -->
                {% set nights = day.nights|default(1)|int %}
                {% if nights > 1 %}
                {% for n in range(nights - 1) %}
                <div class="relative flex flex-col md:flex-row items-center scroll-element fade-in-up">
                    <div
                        class="absolute left-4 md:left-1/2 w-8 h-8 rounded-full bg-green-900 border-4 border-green-500 transform -translate-x-1/2 flex items-center justify-center z-10 shadow-[0_0_15px_rgba(16,185,129,0.5)]">
                        <span class="text-[10px] font-bold text-white">{{ ns.counter }}</span>
                    </div>
                    <div
                        class="md:w-1/2 w-full pl-12 md:pl-0 md:pr-12 md:text-right content-left {% if ns.counter is even %}md:order-1{% else %}md:order-1{% endif %}">
                        {% if ns.counter is odd %}
                        <div
                            class="bg-gray-800/80 backdrop-blur-md p-6 rounded-xl border border-green-700/50 hover:border-green-500 transition-all shadow-xl md:mr-10 md:ml-auto">
                            <h3 class="text-2xl text-white font-heading mb-2">Jour {{ ns.counter }}</h3>
                            <div
                                class="text-green-500 font-bold text-sm mb-4 tracking-wider flex items-center justify-end gap-2">
                                DAY OFF <i class="fas fa-cocktail"></i></div>
                            <p class="text-gray-400 text-sm">Repos et détente à {{ day.city }}</p>
                        </div>
                        {% else %}<div class="hidden md:block"></div>{% endif %}
                    </div>
                    <div
                        class="md:w-1/2 w-full pl-12 md:pl-12 content-right {% if ns.counter is even %}md:order-2{% else %}md:order-2{% endif %}">
                        {% if ns.counter is even %}
                        <div
                            class="bg-gray-800/80 backdrop-blur-md p-6 rounded-xl border border-green-700/50 hover:border-green-500 transition-all shadow-xl md:ml-10">
                            <h3 class="text-2xl text-white font-heading mb-2">Jour {{ ns.counter }}</h3>
                            <div class="text-green-500 font-bold text-sm mb-4 tracking-wider flex items-center gap-2"><i
                                    class="fas fa-cocktail"></i> DAY OFF</div>
                            <p class="text-gray-400 text-sm">Repos et détente à {{ day.city }}</p>
                        </div>
                        {% else %}<div class="hidden md:block"></div>{% endif %}
                    </div>
                </div>
                {% set ns.counter = ns.counter + 1 %}
                {% endfor %}
                {% endif %}

                {% endfor %}
            </div>
        </div>
    </section>

    <!-- 6. GALLERY -->
    {% set display_photos = trip.galleryImages or trip.photos %}
    {% if display_photos %}
    <section class="py-16 bg-[#0f1115]">
        <div class="max-w-7xl mx-auto px-4">
            <h2 class="text-3xl text-white mb-8 font-heading pl-4 border-l-4 border-accent">Un aperçu du voyage</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-4 auto-rows-[200px]">
                {% for photo in display_photos %}
                <div onclick="openLightbox('{{ photo }}')"
                    class="relative group overflow-hidden rounded-lg bg-gray-800 cursor-pointer {% if loop.index % 5 == 0 %}col-span-2 row-span-2{% endif %}">
                    <img src="{{ photo }}" alt="Gallery" loading="lazy"
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-80 group-hover:opacity-100">
                    <div
                        class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <i class="fas fa-search-plus text-white text-3xl drop-shadow-lg"></i>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal" class="fixed inset-0 z-50 bg-black/95 hidden flex items-center justify-center p-4">
        <button onclick="closeLightbox()"
            class="absolute top-4 right-4 text-white hover:text-accent transition-colors"><i
                class="fas fa-times text-4xl"></i></button>
        <img id="lightbox-image" src="" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl">
    </div>
    <script>
        function openLightbox(src) {
            const modal = document.getElementById('lightbox-modal');
            const img = document.getElementById('lightbox-image');
            img.src = src;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        function closeLightbox() {
            const modal = document.getElementById('lightbox-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            setTimeout(() => { document.getElementById('lightbox-image').src = ''; }, 200);
        }
        document.getElementById('lightbox-modal').addEventListener('click', function (e) { if (e.target === this) closeLightbox(); });
        document.addEventListener('keydown', function (evt) { if (evt.key === "Escape") closeLightbox(); });
    </script>
    {% endif %}

    <!-- 7. FAQ SECTION -->
    <section class="py-24 bg-gray-900 border-t border-gray-800">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-3xl text-white mb-12 font-heading text-center">Questions Fréquemment Posées</h2>
            <div class="space-y-4">
                <!-- 1. COMPRIS -->
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                    <button
                        class="w-full flex items-center justify-between p-6 text-left focus:outline-none transition-colors hover:bg-gray-800"
                        onclick="toggleFaq(this)">
                        <span class="text-lg font-bold text-gray-200">Qu'est ce qui est compris dans le prix ?</span>
                        <i class="fas fa-chevron-down text-accent transform transition-transform duration-300"></i>
                    </button>
                    <div class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out bg-gray-900/50">
                        <div class="p-6 pt-0 text-gray-400 space-y-2 text-sm leading-relaxed">
                            <ul class="list-disc pl-5 space-y-2">
                                <li>Les nuitées d’hôtel tout au long de votre itinéraire</li>
                                <li>Les petits déjeuners inclus chaque matin</li>
                                <li>Les fichiers de navigation adaptés à votre GPS (formats GPX, ITN, KML, etc.)</li>
                                <li>Une sélection d’itinéraires panoramiques adaptés aux motos</li>
                                <li>La possibilité d’ajouter des options comme des nuitées supplémentaires ou des
                                    extensions d’itinéraire</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 2. NON COMPRIS -->
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                    <button
                        class="w-full flex items-center justify-between p-6 text-left focus:outline-none transition-colors hover:bg-gray-800"
                        onclick="toggleFaq(this)">
                        <span class="text-lg font-bold text-gray-200">Qu'est-ce qui n'est pas compris dans le prix
                            ?</span>
                        <i class="fas fa-chevron-down text-accent transform transition-transform duration-300"></i>
                    </button>
                    <div class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out bg-gray-900/50">
                        <div class="p-6 pt-0 text-gray-400 space-y-2 text-sm leading-relaxed">
                            <ul class="list-disc pl-5 space-y-2">
                                <li>L'itinéraire et nuitée jusqu’au point de départ du voyage (sauf demande optionnelle)
                                </li>
                                <li>Les repas de midi ainsi que les dîners</li>
                                <li>Les boissons, pourboires, extras et autres dépenses personnelles</li>
                                <li>Le supplément pour une chambre individuelle (sauf si tarif individuel choisi)</li>
                                <li>La moto, le carburant, les péages</li>
                                <li>L’assurance annulation et assistance</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 3. PAIEMENT (Dynamic) -->
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                    <button
                        class="w-full flex items-center justify-between p-6 text-left focus:outline-none transition-colors hover:bg-gray-800"
                        onclick="toggleFaq(this)">
                        <span class="text-lg font-bold text-gray-200">Comment se passe le paiement ?</span>
                        <i class="fas fa-chevron-down text-accent transform transition-transform duration-300"></i>
                    </button>
                    <div class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out bg-gray-900/50">
                        <div class="p-6 pt-0 text-gray-400 space-y-6 text-sm leading-relaxed">
                            <div>
                                <strong class="text-white block mb-2 text-base">Acompte</strong>
                                <p>Un acompte de
                                    <span class="text-accent font-bold">
                                        {% if trip.depositType == 'percentage' %}
                                        {{ trip.depositValue|int }}% du total
                                        {% elif trip.depositType == 'fixed_total' %}
                                        {{ trip.depositValue }} € par groupe
                                        {% else %}
                                        {{ trip.depositValue|default(150) }} € par personne
                                        {% endif %}
                                    </span>
                                    est requis pour confirmer votre réservation, quel que soit le voyage choisi. Le
                                    paiement se fait sur notre plateforme de paiement en ligne et sécurisée.
                                </p>
                            </div>

                            <div>
                                <strong class="text-white block mb-2 text-base">Personnalisation de
                                    l’itinéraire</strong>
                                <p>Une fois l’acompte payé, nous vous contactons pour ajuster l’itinéraire en fonction
                                    de votre adresse de départ et d’arrivée.</p>
                            </div>

                            <div>
                                <strong class="text-white block mb-2 text-base">Paiement du solde</strong>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>Le montant restant doit être réglé dans un délai de 14 jours après la
                                        confirmation de la personnalisation.</li>
                                    <li>Si des nuitées supplémentaires sont ajoutées, leur coût sera intégré au prix
                                        total.</li>
                                </ul>
                            </div>

                            <div>
                                <strong class="text-white block mb-2 text-base">Conditions d’annulation</strong>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>Les acomptes ne sont pas remboursables.</li>
                                    <li>Si vous renoncez au voyage et ne réglez pas le solde, l’acompte sera perdu.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. ANNULATION -->
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                    <button
                        class="w-full flex items-center justify-between p-6 text-left focus:outline-none transition-colors hover:bg-gray-800"
                        onclick="toggleFaq(this)">
                        <span class="text-lg font-bold text-gray-200">Comment cela se passe si je ne sais pas partir
                            ?</span>
                        <i class="fas fa-chevron-down text-accent transform transition-transform duration-300"></i>
                    </button>
                    <div class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out bg-gray-900/50">
                        <div class="p-6 pt-0 text-gray-400 space-y-2 text-sm leading-relaxed">
                            <p class="mb-2">En cas d’annulation de votre voyage, aucun remboursement ne pourra être
                                effectué.</p>
                            <p>Toutefois, nous vous recommandons de souscrire une assurance annulation auprès de votre
                                assureur. OldiBike travail étroitement avec le bureau Begassur, si vous souhaitez
                                obtenir des informations sur leurs assurance annulation n'hésitez pas à cocher la case
                                "Je veux une assurance annulation" lors de la réservation.</p>
                        </div>
                    </div>
                </div>

                <!-- 5. ASSURANCE BEAU TEMPS -->
                <div class="bg-gray-800/50 rounded-lg border border-gray-700 overflow-hidden">
                    <button
                        class="w-full flex items-center justify-between p-6 text-left focus:outline-none transition-colors hover:bg-gray-800"
                        onclick="toggleFaq(this)">
                        <span class="text-lg font-bold text-gray-200">Assurance beau temps</span>
                        <i class="fas fa-chevron-down text-accent transform transition-transform duration-300"></i>
                    </button>
                    <div class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out bg-gray-900/50">
                        <div class="p-6 pt-0 text-gray-400 space-y-2 text-sm leading-relaxed">
                            <p>Optez pour notre assurance beau temps ! Pour 40 € par personne et par voyage, vous avez
                                la possibilité de reporter votre départ une fois en cas de mauvaise météo annoncée.</p>
                            <p class="italic text-xs mt-2">Veuillez noter que toute demande de report doit être
                                effectuée au moins 3 jours avant la date de départ.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 8. BOOKING SECTION -->
    <section id="booking" class="relative py-24 bg-gray-900 border-t border-gray-800">
        <div class="max-w-4xl mx-auto px-6">
            <div
                class="bg-gradient-to-br from-gray-800 to-black p-8 md:p-12 rounded-3xl border border-gray-700 shadow-2xl relative overflow-hidden">
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-accent/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none">
                </div>
                <div class="text-center mb-10">
                    <h2 class="text-4xl md:text-5xl text-white font-heading mb-4">L'Aventure Commence Ici</h2>
                    <p class="text-gray-400 max-w-xl mx-auto">Réservez votre place dès maintenant.</p>
                </div>

                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="mb-8">
                    {% for category, message in messages %}
                    <div
                        class="p-4 rounded bg-{{ 'red' if category == 'error' else 'green' }}-500/20 text-{{ 'red' if category == 'error' else 'green' }}-200 border border-{{ 'red' if category == 'error' else 'green' }}-500/50 text-center">
                        {{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('trips.book_trip', slug=trip.publishedSlug or trip.slug) }}"
                    class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Prénom</label>
                            <input type="text" name="first_name" required placeholder="Votre Prénom"
                                class="w-full bg-gray-900 text-white border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-accent focus:border-transparent">
                        </div>
                        <div>
                            <label
                                class="block text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Nom</label>
                            <input type="text" name="last_name" required placeholder="Votre Nom"
                                class="w-full bg-gray-900 text-white border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-accent focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Départ</label>
                            <input type="date" name="start_date" id="start_date" required
                                class="w-full bg-gray-900 text-white border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-accent focus:border-transparent">
                        </div>
                        <div>
                            <label
                                class="block text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Pilotes</label>
                            <select name="nb_pilots" id="nb_pilots"
                                class="w-full bg-gray-900 text-white border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-accent focus:border-transparent">
                                {% for i in range(1, 11) %}<option value="{{ i }}">{{ i }} Pilote{{ 's' if i > 1 else ''
                                    }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Email</label>
                            <input type="email" name="email" required placeholder="pilote@exemple.com"
                                class="w-full bg-gray-900 text-white border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-accent focus:border-transparent">
                        </div>
                        <div>
                            <label
                                class="block text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">Passagers</label>
                            <select name="nb_passengers" id="nb_passengers"
                                class="w-full bg-gray-900 text-white border border-gray-700 rounded-lg p-4 focus:ring-2 focus:ring-accent focus:border-transparent">
                                <option value="0">Aucun passager</option>
                                {% for i in range(1, 11) %}<option value="{{ i }}">{{ i }} Passager{{ 's' if i > 1 else
                                    '' }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>

                    <div
                        class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 mt-6 flex justify-between items-center">
                        <div>
                            <div class="text-gray-400 text-sm">Total Estimé</div>
                            <div class="text-2xl text-white font-bold" id="total_price_display">{{ trip.pricePerPerson |
                                default(0) }}€</div>
                        </div>
                        <div class="text-right">
                            <div class="text-gray-400 text-sm">Acompte (30%)</div>
                            <div class="text-2xl text-accent font-bold" id="deposit_price_display">--€</div>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input type="checkbox" name="insurance_weather"
                                class="mt-1 w-5 h-5 rounded border-gray-600 bg-gray-700 text-accent focus:ring-accent">
                            <span class="text-sm text-gray-300 group-hover:text-white">Je veux l'<strong>assurance beau
                                    temps</strong></span>
                        </label>
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input type="checkbox" name="insurance_cancellation"
                                class="mt-1 w-5 h-5 rounded border-gray-600 bg-gray-700 text-accent focus:ring-accent">
                            <span class="text-sm text-gray-300 group-hover:text-white">Je souhaite une <strong>assurance
                                    annulation</strong></span>
                        </label>
                    </div>

                    <button type="submit"
                        class="w-full py-5 bg-accent hover-bg-accent text-black font-heading font-bold text-xl uppercase tracking-widest rounded-lg shadow-lg transform transition hover:scale-[1.01] hover:shadow-accent">
                        Confirmer ma réservation
                    </button>
                    <p class="text-center text-gray-500 text-xs mt-4"><i class="fas fa-lock text-gray-600 mr-1"></i>
                        Paiement sécurisé.</p>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer CTA Mobile -->
    <div
        class="md:hidden fixed bottom-0 left-0 w-full bg-gray-900/90 backdrop-blur-lg border-t border-gray-700 p-4 z-50 flex items-center justify-between">
        <div class="text-white"><span class="block text-xs text-gray-400">À partir de</span><span
                class="font-bold text-lg text-accent">{{ trip.pricePerPerson | default(0) }}€</span></div>
        <a href="#booking" class="px-6 py-2 bg-accent text-black font-bold uppercase text-sm rounded">Réserver</a>
    </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
<script src="https://unpkg.com/leaflet-gesture-handling@1.2.2/dist/leaflet-gesture-handling.min.js"></script>
<script>
    // GLOBAL THEME VARIABLES FOR JS
    const themeMain = "{{ theme.main }}";
    const themeLight = "{{ theme.light }}";
    const themeDark = "{{ theme.dark }}";

    document.addEventListener('DOMContentLoaded', () => {
        // ... PRICE CALC ...
        const pricePerPerson = {{ trip.pricePerPerson | default (0)
    }};
    const depositType = "{{ trip.depositType | default('fixed_per_person') }}";
    const depositValue = {{ trip.depositValue | default (150) }};
    const pilotsSelect = document.getElementById('nb_pilots');
    const passengersSelect = document.getElementById('nb_passengers');
    const totalPriceEl = document.getElementById('total_price_display');
    const depositPriceEl = document.getElementById('deposit_price_display');

    function updatePrice() {
        const pilots = parseInt(pilotsSelect ? pilotsSelect.value : 0) || 0;
        const passengers = parseInt(passengersSelect ? passengersSelect.value : 0) || 0;
        const count = pilots + passengers;
        const total = count * pricePerPerson;
        let deposit = 0;
        if (depositType === 'percentage') deposit = total * (depositValue / 100);
        else if (depositType === 'fixed_total') deposit = depositValue;
        else deposit = count * depositValue;
        totalPriceEl.textContent = total + '€';
        depositPriceEl.textContent = Math.round(deposit) + '€';
    }
    if (pilotsSelect) pilotsSelect.addEventListener('change', updatePrice);
    if (passengersSelect) passengersSelect.addEventListener('change', updatePrice);
    if (pilotsSelect || passengersSelect) updatePrice();

    // ... MAP ...
    const mapElement = document.getElementById('trip-map');
    if (mapElement) {
        const map = L.map('trip-map', {
            scrollWheelZoom: false,
            zoomControl: false,
            doubleClickZoom: false,
            touchZoom: false,
            boxZoom: false,
            keyboard: false,
            gestureHandling: true
        }).setView([46.2276, 2.2137], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        const gpxUrls = [{% for day in trip.days %} "{{ day.gpxUrl or '' }}", {% endfor %}].filter(url => url.length > 0);
    if (gpxUrls.length > 0) {
        let loadedTracks = 0;
        const bounds = L.latLngBounds([]);
        gpxUrls.forEach((url, index) => {
            const proxyUrl = `/admin/api/proxy-gpx?url=${encodeURIComponent(url)}`;
            // USE DYNAMIC COLOR
            const color = [themeMain, themeLight, themeDark][index % 3];
            new L.GPX(proxyUrl, {
                async: true,
                marker_options: { startIconUrl: null, endIconUrl: null, shadowUrl: null },
                polyline_options: { color: color, opacity: 0.9, weight: 5, lineCap: 'round' }
            }).on('loaded', function (e) {
                bounds.extend(e.target.getBounds());
                loadedTracks++;
                if (loadedTracks === gpxUrls.length) map.fitBounds(bounds, { padding: [50, 50] });
            }).addTo(map);
        });
    }
        }

    // ... SCROLL ...
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
    document.querySelectorAll('.scroll-element').forEach(el => observer.observe(el));

    // ... HERO PARALLAX ...
    window.addEventListener('scroll', () => {
        const heroBg = document.getElementById('hero-bg');
        if (heroBg && window.scrollY < window.innerHeight) heroBg.style.transform = `translateY(${window.scrollY * 0.5}px)`;
    });

    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('start_date');
    if (startDateInput) startDateInput.min = today;

    window.toggleFaq = function (button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('i');
        if (content.style.maxHeight) {
            content.style.maxHeight = null;
            icon.classList.remove('rotate-180');
        } else {
            content.style.maxHeight = content.scrollHeight + "px";
            icon.classList.add('rotate-180');
        }
    };
    });
</script>
{% endblock %}