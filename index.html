<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoTrip Planner</title>
    <!-- Importation de TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Importation de l'icône (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFNp_SRKMbOncczpg21uL_d0q2bRlpeeY&libraries=places"></script>
    <style>
        /* Police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fond gris clair */
        }
        /* Style pour les modales */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Style pour les éléments désactivés */
        :disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Conteneur principal de l'application -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- En-tête -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 flex items-center">
                <img src="https://static.wixstatic.com/media/5ca515_6dd9b70eb31b4ce5be891b7a284532fd~mv2.png/v1/fill/w_326,h_82,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/oldibikepolice.png" alt="OldiBike Logo" class="h-16 mr-4">
                MotoTrip Planner
            </h1>
            <p class="text-lg text-gray-600 mt-2">Organisez vos itinéraires Kurviger et vos hôtels RateHawk en un seul endroit.</p>
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mt-2">
                <p class="text-sm text-gray-500">
                    Code d'accès : <code id="accessCodeDisplay" class="bg-green-100 text-green-800 px-2 py-1 rounded font-bold">------</code>
                    <button id="show-code-setup-btn" class="ml-2 text-blue-600 hover:text-blue-800 underline text-xs">
                        <i class="fas fa-key mr-1"></i>Configurer
                    </button>
                </p>
                <button id="use-code-btn" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                    <i class="fas fa-sign-in-alt mr-1"></i>Se connecter avec un code
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-1">ID technique : <code id="userIdDisplay" class="bg-gray-100 px-1 rounded text-xs">Chargement...</code></p>
            
            <!-- Bouton de migration (visible uniquement si données localStorage détectées) -->
            <div id="migration-banner" class="mt-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-yellow-800 font-semibold">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Données locales détectées !
                        </p>
                        <p class="text-yellow-700 text-sm mt-1">
                            Vous avez des voyages sauvegardés en local. Cliquez pour les transférer vers Firebase.
                        </p>
                    </div>
                    <button id="migrate-data-btn" class="ml-4 bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 font-medium whitespace-nowrap">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>Migrer mes données
                    </button>
                </div>
            </div>
        </header>

        <!-- Grille principale de l'application -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Colonne 1: Liste des Voyages -->
            <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">Mes Voyages</h2>
                <form id="add-trip-form" class="flex gap-2 mb-4">
                    <input type="text" id="trip-name-input" placeholder="Nom du voyage (ex: Alpes 10 jours)" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required disabled>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium shrink-0" disabled>
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
                <div id="trips-list" class="space-y-2">
                    <!-- Les voyages seront injectés ici par JS -->
                    <p class="text-gray-500">Aucun voyage pour le moment. Ajoutez-en un !</p>
                </div>
            </div>

            <!-- Colonne 2: Détails du Voyage Sélectionné -->
            <div class="md:col-span-2 space-y-6">
                <!-- Section des Étapes -->
                <div id="trip-details-container" class="bg-white p-6 rounded-lg shadow-md hidden">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-4">
                        <h2 class="text-2xl font-semibold">Détails de : <span id="current-trip-name" class="text-blue-600"></span></h2>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <button id="add-day-modal-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-medium w-full sm:w-auto">
                                <i class="fas fa-plus mr-2"></i>Ajouter une étape
                            </button>
                            <button id="manage-media-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 font-medium w-full sm:w-auto">
                                <i class="fas fa-images mr-2"></i>Médias
                            </button>
                        </div>
                    </div>

                    <!-- Calculateur de coût -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg mb-6 border border-blue-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Prix Double -->
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <h3 class="text-sm font-semibold text-gray-600 mb-2">Prix Double</h3>
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Coût total :</span>
                                        <span id="total-double" class="text-lg font-bold text-blue-600">0.00€</span>
                                    </div>
                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                        <span>Par personne :</span>
                                        <span id="total-double-pp" class="font-semibold">0.00€</span>
                                    </div>
                                    <div class="flex justify-between items-center border-t pt-1">
                                        <span class="text-sm text-gray-600">Prix de vente :</span>
                                        <span id="sale-double" class="text-xl font-bold text-green-600">0.00€</span>
                                    </div>
                                    <div class="flex justify-between items-center text-xs text-green-700">
                                        <span>Par personne :</span>
                                        <span id="sale-double-pp" class="font-semibold">0.00€</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Prix Solo -->
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <h3 class="text-sm font-semibold text-gray-600 mb-2">Prix Solo</h3>
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Coût total :</span>
                                        <span id="total-solo" class="text-lg font-bold text-blue-600">0.00€</span>
                                    </div>
                                    <div class="flex justify-between items-center border-t pt-1">
                                        <span class="text-sm text-gray-600">Prix de vente :</span>
                                        <span id="sale-solo" class="text-xl font-bold text-green-600">0.00€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Champ Prix de vente par personne -->
                        <div class="mt-3 bg-white p-4 rounded-lg shadow-sm border-2 border-indigo-200">
                            <div class="flex items-center gap-3 mb-3">
                                <label for="sale-price-pp-input" class="text-sm font-semibold text-gray-700 whitespace-nowrap">
                                    <i class="fas fa-euro-sign mr-1 text-indigo-600"></i>Prix de vente P/P :
                                </label>
                                <input 
                                    type="number" 
                                    id="sale-price-pp-input" 
                                    min="0" 
                                    step="0.01" 
                                    placeholder="0.00" 
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center font-semibold"
                                >
                                <span class="text-sm text-gray-600">€</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                                <span class="text-sm text-gray-600">Marge par personne :</span>
                                <div class="text-right">
                                    <span id="margin-per-person" class="text-lg font-bold text-indigo-600">0.00€</span>
                                    <span id="margin-percent" class="text-xs text-gray-500 ml-2">(0%)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="days-list" class="space-y-4">
                        <!-- Les étapes du voyage seront injectées ici -->
                    </div>
                </div>

                <!-- Section Liste Hôtels RateHawk -->
                <div id="adapter-container" class="bg-white p-6 rounded-lg shadow-md hidden">
                    <h2 class="text-2xl font-semibold mb-4">Liste Hôtels RateHawk</h2>
                    <p class="text-gray-600 mb-4">Enregistrez l'URL de votre sélection d'hôtels RateHawk pour ce voyage.</p>
                    <div class="flex flex-col gap-3">
                        <button id="encode-hotel-list-btn" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 font-semibold flex items-center justify-center">
                            <i class="fas fa-edit mr-2"></i>
                            Encoder liste hôtel
                        </button>
                        <button id="view-hotel-list-btn" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-semibold flex items-center justify-center" disabled>
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Consulter liste hôtel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale pour Ajouter une Étape -->
    <div id="add-day-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50 overflow-y-auto">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg transform scale-95 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold">Ajouter une nouvelle étape</h3>
                <button type="button" id="search-nearby-hotels-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium flex items-center gap-2" title="Rechercher des hôtels à proximité">
                    <i class="fas fa-search"></i>
                    <span class="hidden sm:inline">Hôtels à proximité</span>
                </button>
            </div>
            <form id="add-day-form">
                <input type="hidden" id="editing-day-id"> <!-- Pour le mode édition -->
                <div class="space-y-4">
                    <div>
                        <label for="day-name" class="block text-sm font-medium text-gray-700">Nom du Jour (ex: Jour 1, Jour 2C)</label>
                        <input type="text" id="day-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="day-city" class="block text-sm font-medium text-gray-700">Ville</label>
                        <input type="text" id="day-city" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Epinal" required>
                    </div>
                    
                    <div>
                        <label for="day-hotel-name" class="block text-sm font-medium text-gray-700">Nom de l'hôtel</label>
                        <input type="text" id="day-hotel-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Logis Hôtel Atrium" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="day-price-double" class="block text-sm font-medium text-gray-700">Prix Double (€)</label>
                            <input type="number" id="day-price-double" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                        </div>
                        <div>
                            <label for="day-price-solo" class="block text-sm font-medium text-gray-700">Prix Solo (€)</label>
                            <input type="number" id="day-price-solo" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                        </div>
                    </div>

                    <div>
                        <label for="day-nights" class="block text-sm font-medium text-gray-700">Nombre de nuits <span class="text-xs text-gray-500">(optionnel)</span></label>
                        <input type="number" id="day-nights" min="1" step="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="1">
                        <p class="text-xs text-gray-500 mt-1">Indiquez si vous restez plusieurs nuits à cette étape. Le prix ne sera pas multiplié.</p>
                    </div>
                    
                    <div>
                        <label for="day-gpx-file" class="block text-sm font-medium text-gray-700">Fichier GPX (ex: Jour 1)</label>
                        <input type="text" id="day-gpx-file" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="day-hotel-link" class="block text-sm font-medium text-gray-700">URL Hôtel (RateHawk, etc.)</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="url" id="day-hotel-link" class="block w-full flex-1 rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="https://...">
                            <button type="button" id="open-hotel-link-btn" class="relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-gray-300 bg-gray-50 px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" title="Ouvrir le lien dans un nouvel onglet">
                                <i class="fas fa-external-link-alt text-gray-500"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-add-day-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">Annuler</button>
                    <button type="submit" id="save-day-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">Enregistrer l'étape</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale pour Encoder l'URL de la Liste RateHawk -->
    <div id="encode-hotel-list-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <h3 class="text-2xl font-semibold mb-4 text-indigo-600">
                <i class="fas fa-edit mr-2"></i>Encoder l'URL de la liste RateHawk
            </h3>
            <p class="text-gray-700 mb-4">
                Collez ici l'URL de votre sélection d'hôtels RateHawk pour ce voyage.
            </p>
            <div class="mb-6">
                <label for="ratehawk-url-input" class="block text-sm font-medium text-gray-700 mb-2">
                    URL RateHawk :
                </label>
                <input 
                    type="url" 
                    id="ratehawk-url-input" 
                    placeholder="https://www.ratehawk.com/..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-encode-hotel-list-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Annuler
                </button>
                <button type="button" id="save-hotel-list-url-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium">
                    <i class="fas fa-save mr-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modale de Confirmation de Suppression -->
    <div id="delete-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-2xl font-semibold mb-4 text-red-600">Confirmer la suppression</h3>
            <p id="delete-confirm-message" class="text-gray-700 mb-6">Voulez-vous vraiment supprimer cet élément ?</p>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">Annuler</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-medium">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Modale pour Ré-attribuer une Étape -->
    <div id="reassign-day-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-2xl font-semibold mb-2">Ré-attribuer l'étape</h3>
            <p id="reassign-day-name" class="text-gray-600 mb-6"></p>
            <div>
                <label for="destination-trip-select" class="block text-sm font-medium text-gray-700 mb-2">Choisir le voyage de destination :</label>
                <select id="destination-trip-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button type="button" id="cancel-reassign-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">Annuler</button>
                <button type="button" id="copy-day-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">Copier</button>
                <button type="button" id="move-day-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 font-medium">Déplacer</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 hidden z-50">
        <span id="toast-message"></span>
    </div>

    <!-- Modale de Configuration de Code -->
    <div id="code-setup-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-2xl font-semibold mb-4 text-green-600">
                <i class="fas fa-key mr-2"></i>Configurer votre code d'accès
            </h3>
            <p class="text-gray-700 mb-4">
                Choisissez un code à 6 chiffres pour accéder à vos voyages depuis n'importe quel appareil.
            </p>
            <div class="mb-4">
                <label for="new-access-code-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Votre code (6 chiffres) :
                </label>
                <input 
                    type="text" 
                    id="new-access-code-input" 
                    maxlength="6"
                    placeholder="123456"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 font-mono text-2xl text-center font-bold"
                >
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Notez bien ce code ! Vous en aurez besoin pour vous connecter depuis vos autres appareils.
                </p>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-code-setup-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Annuler
                </button>
                <button type="button" id="confirm-code-setup-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-medium">
                    <i class="fas fa-check mr-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de Connexion avec Code -->
    <div id="use-code-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-2xl font-semibold mb-4 text-blue-600">
                <i class="fas fa-sign-in-alt mr-2"></i>Se connecter avec un code
            </h3>
            <p class="text-gray-700 mb-4">
                Entrez le code d'accès que vous avez configuré sur un autre appareil.
            </p>
            <div class="mb-4">
                <label for="enter-access-code-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Code d'accès (6 chiffres) :
                </label>
                <input 
                    type="text" 
                    id="enter-access-code-input" 
                    maxlength="6"
                    placeholder="123456"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-2xl text-center font-bold"
                >
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-use-code-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Annuler
                </button>
                <button type="button" id="confirm-use-code-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
                    <i class="fas fa-unlock mr-2"></i>Se connecter
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de Restauration de Compte -->
    <div id="restore-account-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-2xl font-semibold mb-4 text-blue-600">
                <i class="fas fa-user-circle mr-2"></i>Restaurer mon compte
            </h3>
            <p class="text-gray-700 mb-4">
                Si vous aviez déjà créé des voyages avec un ancien ID utilisateur, entrez-le ici pour retrouver vos données.
            </p>
            <div class="mb-4">
                <label for="old-user-id-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Ancien ID utilisateur :
                </label>
                <input 
                    type="text" 
                    id="old-user-id-input" 
                    placeholder="Ex: uoYbfWJcbnPJ4sveaL23v73dOAO2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                >
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Vous pouvez trouver cet ID en ouvrant la console du navigateur (F12) sur votre ancien site et en tapant : localStorage
                </p>
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-restore-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Annuler
                </button>
                <button type="button" id="confirm-restore-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
                    <i class="fas fa-sync-alt mr-2"></i>Restaurer
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de Recherche d'Hôtels à Proximité -->
    <div id="nearby-hotels-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50 overflow-y-auto">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl transform scale-95 my-8">
            <h3 class="text-2xl font-semibold mb-4 text-indigo-600">
                <i class="fas fa-search mr-2"></i>Rechercher des hôtels à proximité
            </h3>
            <p class="text-gray-700 mb-4">
                Entrez le nom d'une ville pour rechercher les hôtels que vous avez déjà utilisés dans un rayon de 20km.
            </p>
            <div class="mb-4">
                <label for="search-city-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Ville à rechercher :
                </label>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="search-city-input" 
                        placeholder="Ex: Lyon, Besançon..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    >
                    <button type="button" id="perform-search-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 font-medium">
                        <i class="fas fa-search mr-2"></i>Rechercher
                    </button>
                </div>
            </div>
            
            <!-- Zone de résultats -->
            <div id="search-results" class="hidden">
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold text-lg mb-3">Hôtels trouvés à proximité :</h4>
                    <div id="results-list" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Les résultats seront injectés ici -->
                    </div>
                </div>
            </div>
            
            <!-- Message si aucun résultat -->
            <div id="no-results" class="hidden border-t pt-4 mt-4">
                <p class="text-gray-600 text-center py-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    Aucun hôtel trouvé dans un rayon de 20km autour de cette ville.
                </p>
            </div>
            
            <!-- Loader -->
            <div id="search-loader" class="hidden border-t pt-4 mt-4">
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-600">Recherche en cours...</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="close-nearby-hotels-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de Migration -->
    <div id="migration-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-2xl font-semibold mb-4 text-blue-600">
                <i class="fas fa-cloud-upload-alt mr-2"></i>Migration des données
            </h3>
            <div id="migration-content">
                <p class="text-gray-700 mb-4">Nous allons transférer vos données locales vers Firebase :</p>
                <div id="migration-summary" class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-gray-600">Analyse en cours...</p>
                </div>
                <p class="text-sm text-gray-500 mb-6">
                    <i class="fas fa-info-circle mr-1"></i>
                    Cette opération est sans risque. Vos données locales seront conservées jusqu'à confirmation.
                </p>
            </div>
            <div id="migration-progress" class="hidden">
                <div class="flex items-center justify-center mb-4">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
                <p class="text-center text-gray-600">Migration en cours...</p>
            </div>
            <div id="migration-success" class="hidden">
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-check-circle text-green-500 text-5xl"></i>
                </div>
                <p class="text-center text-gray-700 font-semibold">Migration réussie !</p>
                <p class="text-center text-sm text-gray-500 mt-2">Vos données sont maintenant synchronisées avec Firebase.</p>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="cancel-migration-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">Annuler</button>
                <button type="button" id="confirm-migration-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">Commencer la migration</button>
                <button type="button" id="close-migration-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium hidden">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modale Gestionnaire de Médias -->
    <div id="media-manager-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50 overflow-y-auto">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-5xl transform scale-95 my-8 max-h-[90vh] overflow-hidden flex flex-col">
            
            <!-- En-tête -->
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-2xl font-semibold text-gray-900">
                    <i class="fas fa-images mr-2 text-purple-600"></i>
                    Médias - <span id="media-trip-name"></span>
                </h3>
                <button type="button" id="close-media-manager-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Onglets -->
            <div class="flex border-b bg-gray-50">
                <button id="tab-general-btn" class="flex-1 px-6 py-3 font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 border-b-4 border-purple-600 transition-colors">
                    <i class="fas fa-mountain mr-2"></i>Cols & Routes
                </button>
                <button id="tab-hotels-btn" class="flex-1 px-6 py-3 font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 border-b-4 border-transparent transition-colors">
                    <i class="fas fa-hotel mr-2"></i>Hôtels
                </button>
            </div>

            <!-- Contenu dynamique des onglets -->
            <div class="flex-1 overflow-y-auto p-6">
                
                <!-- ONGLET 1 : Cols & Routes -->
                <div id="tab-general-content" class="space-y-4">
                    
                    <!-- Barre de recherche -->
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" 
                                   id="search-tags-input" 
                                   placeholder="Rechercher par tag (ex: Stelvio, Furka...)"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Bouton upload -->
                    <div>
                        <input type="file" id="upload-general-input" accept="image/*" multiple class="hidden">
                        <button id="upload-general-btn" class="w-full bg-purple-600 text-white px-4 py-3 rounded-md hover:bg-purple-700 font-medium flex items-center justify-center gap-2">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Ajouter des photos (cols, routes, POI)
                        </button>
                    </div>

                    <!-- Tags populaires -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2">
                            <i class="fas fa-tags mr-2"></i>Tags populaires :
                        </p>
                        <div id="popular-tags-container" class="flex flex-wrap gap-2">
                            <!-- Les tags seront injectés dynamiquement -->
                        </div>
                    </div>

                    <!-- Galerie de photos -->
                    <div id="general-photos-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mt-6">
                        <!-- Les photos seront injectées ici -->
                    </div>

                    <!-- Message si vide -->
                    <div id="no-general-photos" class="text-center py-12 text-gray-500 hidden">
                        <i class="fas fa-images text-5xl mb-4 opacity-50"></i>
                        <p>Aucune photo. Ajoutez des photos de vos cols et routes !</p>
                    </div>

                    <!-- Monitoring espace -->
                    <div class="bg-blue-50 p-4 rounded-lg mt-6">
                        <p class="text-sm text-gray-600 mb-2">
                            📊 Espace utilisé : <strong id="space-used-general">0 MB</strong> / 5 GB
                        </p>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="space-bar-general" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET 2 : Hôtels -->
                <div id="tab-hotels-content" class="space-y-4 hidden">
                    
                    <!-- Barre de recherche hôtel -->
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <input type="text" 
                                   id="search-hotels-input" 
                                   placeholder="Rechercher un hôtel..."
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Bouton upload -->
                    <div>
                        <input type="file" id="upload-hotel-input" accept="image/*" multiple class="hidden">
                        <button id="upload-hotel-btn" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 font-medium flex items-center justify-center gap-2">
                            <i class="fas fa-hotel mr-2"></i>
                            Ajouter photos d'hôtel
                        </button>
                    </div>

                    <!-- Liste des hôtels avec photos -->
                    <div id="hotels-photos-list" class="space-y-4 mt-6">
                        <!-- Les hôtels seront injectés ici -->
                    </div>

                    <!-- Message si vide -->
                    <div id="no-hotel-photos" class="text-center py-12 text-gray-500 hidden">
                        <i class="fas fa-hotel text-5xl mb-4 opacity-50"></i>
                        <p>Aucune photo d'hôtel. Uploadez des photos de vos hébergements !</p>
                    </div>

                    <!-- Monitoring espace -->
                    <div class="bg-blue-50 p-4 rounded-lg mt-6">
                        <p class="text-sm text-gray-600 mb-2">
                            📊 Espace utilisé : <strong id="space-used-hotels">0 MB</strong> / 5 GB
                        </p>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="space-bar-hotels" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Modale de Tagging -->
    <div id="tagging-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-[60]">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <h3 class="text-xl font-semibold mb-4 text-purple-600">
                <i class="fas fa-tags mr-2"></i>Ajouter des tags
            </h3>
            
            <p class="text-gray-600 mb-4">
                Vous uploadez <strong id="files-count">0</strong> photo(s)
            </p>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Tags (séparés par virgule) :
                </label>
                <input type="text" 
                       id="tags-input" 
                       placeholder="Ex: Stelvio, Col, Italie"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>

            <div class="mb-6">
                <p class="text-sm text-gray-600 mb-2">Suggestions :</p>
                <div id="suggested-tags" class="flex flex-wrap gap-2">
                    <!-- Tags suggérés injectés ici -->
                </div>
            </div>

            <!-- Barre de progression -->
            <div id="upload-progress-container" class="mb-4 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="upload-progress-bar" class="bg-purple-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2 text-center">
                    Upload en cours... <span id="upload-progress-text">0%</span>
                </p>
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-tagging-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Annuler
                </button>
                <button type="button" id="confirm-upload-general-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 font-medium">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Uploader
                </button>
            </div>
        </div>
    </div>

    <!-- Modale de Sélection d'Hôtel -->
    <div id="hotel-selection-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-[60]">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md transform scale-95 max-h-[80vh] overflow-hidden flex flex-col">
            <h3 class="text-xl font-semibold mb-4 text-indigo-600">
                <i class="fas fa-hotel mr-2"></i>Sélectionner un hôtel
            </h3>
            
            <p class="text-gray-600 mb-4">
                Vous uploadez <strong id="hotel-files-count">0</strong> photo(s)
            </p>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Choisir l'étape/hôtel :
                </label>
                <div id="hotels-list-selection" class="space-y-2 max-h-64 overflow-y-auto border border-gray-300 rounded-md p-2">
                    <!-- Liste des hôtels injectée ici -->
                </div>
            </div>

            <!-- Barre de progression -->
            <div id="upload-hotel-progress-container" class="mb-4 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="upload-hotel-progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2 text-center">
                    Upload en cours... <span id="upload-hotel-progress-text">0%</span>
                </p>
            </div>

            <div class="flex justify-end gap-4 mt-4">
                <button type="button" id="cancel-hotel-selection-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-medium">
                    Annuler
                </button>
                <button type="button" id="confirm-upload-hotel-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium" disabled>
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Uploader
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Lightbox Photos Hôtel -->
    <div id="hotel-lightbox-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 hidden z-[60]">
        <div class="w-full max-w-4xl">
            
            <!-- En-tête -->
            <div class="flex justify-between items-center mb-4 text-white">
                <div>
                    <h3 class="text-xl font-semibold" id="lightbox-hotel-name"></h3>
                    <p class="text-sm text-gray-300" id="lightbox-day-name"></p>
                </div>
                <button type="button" id="close-lightbox-btn" class="text-white hover:text-gray-300 text-3xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Image principale -->
            <div class="relative bg-black rounded-lg overflow-hidden mb-4" style="min-height: 400px;">
                <img id="lightbox-main-image" src="" alt="" class="w-full h-auto max-h-[70vh] object-contain">
                
                <!-- Boutons navigation -->
                <button id="lightbox-prev-btn" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-900 w-12 h-12 rounded-full flex items-center justify-center">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="lightbox-next-btn" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-900 w-12 h-12 rounded-full flex items-center justify-center">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Miniatures -->
            <div id="lightbox-thumbnails" class="flex gap-2 overflow-x-auto pb-2">
                <!-- Miniatures injectées ici -->
            </div>

            <!-- Footer -->
            <div class="flex justify-between items-center text-white mt-4">
                <p class="text-sm">
                    Photo <span id="lightbox-current-index">1</span> / <span id="lightbox-total-count">1</span>
                </p>
                <button id="lightbox-download-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md font-medium">
                    <i class="fas fa-download mr-2"></i>Télécharger
                </button>
            </div>

        </div>
    </div>

    <!-- Importation de Firebase -->
    <script type="module">
        // Importations Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            collection, 
            query, 
            onSnapshot,
            getDocs,
            getDoc,
            orderBy,
            serverTimestamp,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL, 
            deleteObject 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Variables d'état globales
        let userId = null;
        let currentTripId = null;
        let currentTripName = null;
        let unsubscribeTrips = null;
        let unsubscribeDays = null;
        let allDaysCache = []; // Cache pour l'outil d'adaptation
        let stepToReassign = null; // Pour la ré-attribution d'étape
        let localStorageData = null; // Cache des données localStorage
        
        // Variables Firebase (seront initialisées plus tard)
        let app, auth, db, storage;
        let appId = 'default-app-id'; // Peut être surchargé si nécessaire
        
        // Variables pour le système de médias
        let selectedFilesGeneral = []; // Fichiers sélectionnés pour upload général
        let selectedFilesHotel = []; // Fichiers sélectionnés pour upload hôtel
        let selectedHotelForUpload = null; // {dayId, hotelName, dayName}
        let allGeneralPhotos = []; // Cache des photos générales
        let allHotelPhotos = []; // Cache des photos d'hôtels
        let currentLightboxPhotos = []; // Photos dans la lightbox
        let currentLightboxIndex = 0; // Index actuel dans la lightbox
        let hotelPhotoCounts = {}; // Cache des compteurs {dayId: count}


        // Éléments DOM
        const showCodeSetupBtn = document.getElementById('show-code-setup-btn');
        const useCodeBtn = document.getElementById('use-code-btn');
        const codeSetupModal = document.getElementById('code-setup-modal');
        const useCodeModal = document.getElementById('use-code-modal');
        const newAccessCodeInput = document.getElementById('new-access-code-input');
        const enterAccessCodeInput = document.getElementById('enter-access-code-input');
        const cancelCodeSetupBtn = document.getElementById('cancel-code-setup-btn');
        const confirmCodeSetupBtn = document.getElementById('confirm-code-setup-btn');
        const cancelUseCodeBtn = document.getElementById('cancel-use-code-btn');
        const confirmUseCodeBtn = document.getElementById('confirm-use-code-btn');
        const accessCodeDisplay = document.getElementById('accessCodeDisplay');
        const migrationBanner = document.getElementById('migration-banner');
        const migrationModal = document.getElementById('migration-modal');
        const migrateDataBtn = document.getElementById('migrate-data-btn');
        const cancelMigrationBtn = document.getElementById('cancel-migration-btn');
        const confirmMigrationBtn = document.getElementById('confirm-migration-btn');
        const closeMigrationBtn = document.getElementById('close-migration-btn');
        const migrationSummary = document.getElementById('migration-summary');
        const migrationContent = document.getElementById('migration-content');
        const migrationProgress = document.getElementById('migration-progress');
        const migrationSuccess = document.getElementById('migration-success');
        const tripsListEl = document.getElementById('trips-list');
        const daysListEl = document.getElementById('days-list');
        const addTripForm = document.getElementById('add-trip-form');
        const tripNameInput = document.getElementById('trip-name-input');
        const addTripButton = document.querySelector('#add-trip-form button');
        const addDayForm = document.getElementById('add-day-form');
        const tripDetailsContainer = document.getElementById('trip-details-container');
        const adapterContainer = document.getElementById('adapter-container');
        const currentTripNameEl = document.getElementById('current-trip-name');
        
        // Modales
        const addDayModal = document.getElementById('add-day-modal');
        const addDayModalBtn = document.getElementById('add-day-modal-btn');
        const cancelAddDayBtn = document.getElementById('cancel-add-day-btn');
        const reassignDayModal = document.getElementById('reassign-day-modal');
        const cancelReassignBtn = document.getElementById('cancel-reassign-btn');
        const copyDayBtn = document.getElementById('copy-day-btn');
        const moveDayBtn = document.getElementById('move-day-btn');
        const destinationTripSelect = document.getElementById('destination-trip-select');
        const reassignDayNameEl = document.getElementById('reassign-day-name');
        const addDayModalTitle = addDayModal.querySelector('h3');
        const saveDayBtn = document.getElementById('save-day-btn');
        
        // Modale de suppression
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        let deleteCallback = null; // Stocke la fonction à appeler

        // Toast
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        /**
         * Extrait la ville et le nom de l'hôtel depuis une URL RateHawk.
         */
        function parseRateHawkUrl(url) {
            try {
                // URL format: https://www.ratehawk.com/hotel/france/chemaudin/mid9010270/hotel_akena_besancon/...
                const urlObj = new URL(url);
                const pathParts = urlObj.pathname.split('/').filter(p => p);
                
                if (pathParts[0] === 'hotel' && pathParts.length >= 5) {
                    // pathParts[1] = pays (france)
                    // pathParts[2] = ville (chemaudin)
                    // pathParts[3] = id (mid9010270)
                    // pathParts[4] = nom de l'hôtel (hotel_akena_besancon)
                    
                    const city = pathParts[2].replace(/_/g, ' ').replace(/-/g, ' ');
                    const hotelSlug = pathParts[4].replace(/_/g, ' ').replace(/-/g, ' ');
                    
                    // Capitalize first letter of each word
                    const capitalizeWords = (str) => str.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    
                    return {
                        city: capitalizeWords(city),
                        hotelName: capitalizeWords(hotelSlug)
                    };
                }
            } catch (e) {
                console.error('Erreur lors du parsing de l\'URL:', e);
            }
            return null;
        }

        /**
         * Affiche une notification toast.
         */
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'hidden', 'opacity-0');
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            toast.classList.add('opacity-100');

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        /**
         * Bascule la visibilité d'une modale.
         */
        function toggleModal(modalEl, show) {
            const content = modalEl.querySelector('.modal-content');
            if (show) {
                modalEl.classList.remove('hidden');
                setTimeout(() => {
                    modalEl.classList.remove('opacity-0'); // Assurez-vous que l'opacité est à 1
                    if(content) content.classList.remove('scale-95');
                }, 10);
            } else {
                modalEl.classList.add('opacity-0');
                 if(content) content.classList.add('scale-95');
                setTimeout(() => {
                    modalEl.classList.add('hidden');
                }, 250);
            }
        }
        
        /**
         * Affiche la modale de confirmation de suppression.
         */
        function showDeleteConfirm(message, callback) {
            deleteConfirmMessage.textContent = message;
            deleteCallback = callback;
            toggleModal(deleteConfirmModal, true);
        }
        
        // Listeners pour la modale de suppression
        cancelDeleteBtn.addEventListener('click', () => {
            deleteCallback = null;
            toggleModal(deleteConfirmModal, false);
        });
        
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteCallback) {
                deleteCallback();
            }
            deleteCallback = null;
            toggleModal(deleteConfirmModal, false);
        });
        
        deleteConfirmModal.addEventListener('click', (e) => {
            if (e.target === deleteConfirmModal) {
                deleteCallback = null;
                toggleModal(deleteConfirmModal, false);
            }
        });

        /**
         * Une fois l'authentification réussie, cette fonction est appelée.
         */
        function onAuthSuccess() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Vérifie s'il y a un userId restauré dans localStorage
                    const savedUserId = localStorage.getItem('savedUserId');
                    
                    if (savedUserId) {
                        // Utilise l'ancien userId restauré
                        userId = savedUserId;
                        console.log('Utilisation du userId restauré:', userId);
                    } else {
                        // Utilise le nouveau userId et le sauvegarde
                        userId = user.uid;
                        localStorage.setItem('savedUserId', userId);
                        console.log('Nouveau userId sauvegardé:', userId);
                    }
                    
                    document.getElementById('userIdDisplay').textContent = userId;
                    // Active les formulaires maintenant que l'utilisateur est connecté
                    tripNameInput.disabled = false;
                    addTripButton.disabled = false;
                    
                    // Charge et affiche le code d'accès
                    loadAccessCode();
                    
                    // Vérifie s'il y a des données localStorage à migrer
                    checkForLocalStorageData();
                    
                    loadTrips();
                } else {
                    userId = null;
                    document.getElementById('userIdDisplay').textContent = "Non connecté";
                    // Désactive les formulaires
                    tripNameInput.disabled = true;
                    addTripButton.disabled = true;

                    // Nettoyer l'interface
                    if (unsubscribeTrips) unsubscribeTrips();
                    if (unsubscribeDays) unsubscribeDays();
                    tripsListEl.innerHTML = '<p class="text-gray-500">Veuillez vous connecter.</p>';
                    tripDetailsContainer.classList.add('hidden');
                    adapterContainer.classList.add('hidden');
                }
            });
        }

        /**
         * Gère l'authentification et démarre l'application.
         */
        async function initAuth(firebaseConfig, initialAuthToken) {
            try {
                // Initialisation Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback sur l'authentification anonyme si aucun token n'est fourni
                    await signInAnonymously(auth);
                }
                
                // Si tout va bien, on continue
                onAuthSuccess();

            } catch (error) {
                console.error("Erreur d'initialisation ou d'authentification:", error);
                document.getElementById('userIdDisplay').textContent = "Erreur de config";
                showToast("Erreur de configuration Firebase", "error");
                // En cas d'erreur, on ré-affiche la modale de configuration
                toggleModal(document.getElementById('config-modal'), true);
            }
        }

        /**
         * Point d'entrée de l'application. Vérifie la configuration.
         */
        function startApp() {
            // La configuration est maintenant directement dans le code.
            const firebaseConfig = {
                apiKey: "AIzaSyA6h4eD-H9p1iFK8tf-2QFS-PzVcjGmGOo",
                authDomain: "mototrip-63c76.firebaseapp.com",
                projectId: "mototrip-63c76",
                storageBucket: "mototrip-63c76.appspot.com",
                messagingSenderId: "1080042188681",
                appId: "1:1080042188681:web:335bc72f4ae5b3a9f7fb58",
                measurementId: "G-4XMMVPSY72"
            };

            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Démarrage avec la config ci-dessus et authentification anonyme (token = null)
            initAuth(firebaseConfig, null);
        }
        /**
         * Charge la liste des voyages depuis Firestore.
         */
        function loadTrips() {
            if (!userId) return;
            
            const tripsCollectionPath = `artifacts/${appId}/users/${userId}/trips`;
            // Trie par nom
            const q = query(collection(db, tripsCollectionPath), orderBy("name"));

            if (unsubscribeTrips) unsubscribeTrips(); // Se désabonne de l'ancien listener

            unsubscribeTrips = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tripsListEl.innerHTML = '<p class="text-gray-500">Aucun voyage. Ajoutez-en un !</p>';
                    return;
                }
                
                tripsListEl.innerHTML = ''; // Nettoie la liste
                snapshot.forEach((doc) => {
                    const trip = doc.data();
                    const tripEl = document.createElement('div');
                    tripEl.className = `flex justify-between items-center p-3 rounded-md cursor-pointer transition-colors ${doc.id === currentTripId ? 'bg-blue-100 text-blue-800' : 'hover:bg-gray-100'}`;
                    tripEl.dataset.id = doc.id;
                    tripEl.dataset.name = trip.name;

                    tripEl.innerHTML = `
                        <span class="font-medium">${trip.name}</span>
                        <button data-id="${doc.id}" data-name="${trip.name}" class="delete-trip-btn text-red-500 hover:text-red-700 opacity-50 hover:opacity-100 transition-opacity">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    
                    // Gère la sélection du voyage
                    tripEl.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-trip-btn')) return; // Ne pas sélectionner si on clique sur supprimer
                        selectTrip(doc.id, trip.name);
                    });

                    // Gère la suppression
                    tripEl.querySelector('.delete-trip-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Empêche la sélection
                        deleteTrip(doc.id, trip.name);
                    });

                    tripsListEl.appendChild(tripEl);
                });
            }, (error) => {
                console.error("Erreur lors du chargement des voyages:", error);
                showToast("Erreur de chargement des voyages", "error");
            });
        }

        /**
         * Gère l'ajout d'un nouveau voyage.
         */
        addTripForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                showToast("Vous n'êtes pas connecté.", "error");
                return;
            }

            const tripName = tripNameInput.value.trim();
            if (!tripName) return;

            const tripsCollectionPath = `artifacts/${appId}/users/${userId}/trips`;
            
            try {
                await addDoc(collection(db, tripsCollectionPath), {
                    name: tripName,
                    createdAt: serverTimestamp()
                });
                tripNameInput.value = ''; // Réinitialise le champ
                showToast("Voyage ajouté !", "success");
            } catch (error) {
                console.error("Erreur lors de l'ajout du voyage:", error);
                showToast("Erreur lors de l'ajout du voyage", "error");
            }
        });

        /**
         * Gère la suppression d'un voyage (et de ses étapes).
         */
        async function deleteTrip(tripId, tripName) {
            // NOTE: La suppression d'une sous-collection depuis le client est complexe.
            // Pour cette V1, nous ne supprimons que le document du voyage.
            // Une solution complète nécessiterait une Cloud Function.
            // Les étapes deviendront "orphelines" mais inaccessibles via l'UI.
            
            showDeleteConfirm(`Voulez-vous vraiment supprimer le voyage "${tripName}" ?\n(Note: Les étapes associées ne seront plus accessibles.)`, async () => {
                try {
                    const tripDocPath = `artifacts/${appId}/users/${userId}/trips/${tripId}`;
                    await deleteDoc(doc(db, tripDocPath));
                    
                    if (currentTripId === tripId) {
                        currentTripId = null;
                        currentTripName = null;
                        tripDetailsContainer.classList.add('hidden');
                        adapterContainer.classList.add('hidden');
                    }
                    showToast("Voyage supprimé.", "success");
                } catch (error) {
                    console.error("Erreur lors de la suppression du voyage:", error);
                    showToast("Erreur de suppression", "error");
                }
            });
        }

        /**
         * Sélectionne un voyage et charge ses étapes.
         */
        async function selectTrip(tripId, tripName) {
            currentTripId = tripId;
            currentTripName = tripName;

            currentTripNameEl.textContent = tripName;
            tripDetailsContainer.classList.remove('hidden');
            adapterContainer.classList.remove('hidden');

            // Met à jour le style de la liste des voyages (recharge pour le style)
            Array.from(tripsListEl.children).forEach(child => {
                if (child.dataset.id === tripId) {
                    child.classList.add('bg-blue-100', 'text-blue-800');
                    child.classList.remove('hover:bg-gray-100');
                } else {
                    child.classList.remove('bg-blue-100', 'text-blue-800');
                    child.classList.add('hover:bg-gray-100');
                }
            });
            
            // Charge le prix de vente et l'URL RateHawk sauvegardés pour ce voyage
            try {
                const tripDocPath = `artifacts/${appId}/users/${userId}/trips/${tripId}`;
                const tripDoc = await getDoc(doc(db, tripDocPath));
                if (tripDoc.exists()) {
                    const tripData = tripDoc.data();
                    const salePricePP = tripData.salePricePerPerson || 0;
                    document.getElementById('sale-price-pp-input').value = salePricePP > 0 ? salePricePP : '';
                    
                    // Charge l'URL RateHawk
                    currentRatehawkUrl = tripData.ratehawkListUrl || null;
                    viewHotelListBtn.disabled = !currentRatehawkUrl;
                }
            } catch (error) {
                console.error("Erreur lors du chargement des données du voyage:", error);
            }
            
            loadDays();
        }

        /**
         * Charge les étapes du voyage sélectionné.
         */
        function loadDays() {
            if (!userId || !currentTripId) return;

            const daysCollectionPath = `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days`;
            // Trie par date de création pour garder l'ordre d'ajout
            const q = query(collection(db, daysCollectionPath), orderBy("createdAt"));

            if (unsubscribeDays) unsubscribeDays(); // Se désabonne

            unsubscribeDays = onSnapshot(q, (snapshot) => {
                daysListEl.innerHTML = '';
                allDaysCache = []; // Réinitialise le cache

                if (snapshot.empty) {
                    daysListEl.innerHTML = '<p class="text-gray-500">Aucune étape pour ce voyage. Ajoutez-en une !</p>';
                    return;
                }

                snapshot.forEach(async (doc) => {
                    const day = doc.data();
                    day.id = doc.id;
                    allDaysCache.push(day); // Ajoute au cache pour l'adaptateur

                    // NOUVEAU : Compte les photos de l'hôtel
                    const hotelPhotosCount = await countHotelPhotos(day.id);

                    // Affiche dans la liste des détails
                    const dayEl = document.createElement('div');
                    dayEl.className = 'border border-gray-200 p-4 rounded-lg flex justify-between items-start';
                    dayEl.innerHTML = `
                        <div class="flex-grow overflow-hidden pr-2">
                            <h4 class="font-semibold text-lg">
                                ${day.dayName} 
                                ${day.city ? `<span class="text-gray-500 font-normal text-base">• ${day.city}</span>` : ''}
                                ${day.nights && day.nights > 1 ? `<span class="ml-2 bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xs font-semibold"><i class="fas fa-moon mr-1"></i>${day.nights} nuits</span>` : ''}
                            </h4>
                            <p class="text-gray-700 truncate">
                                <i class="fas fa-hotel text-gray-500 w-4 mr-1"></i> 
                                ${day.hotelName}
                                ${day.hotelLink ? `<a href="${day.hotelLink}" target="_blank" class="text-blue-500 hover:underline ml-2"><i class="fas fa-external-link-alt text-xs"></i></a>` : ''}
                            </p>
                            <p class="text-gray-600 text-sm mt-1">
                                <i class="fas fa-users text-gray-500 w-4 mr-1"></i> Double: <strong>${day.priceDouble.toFixed(2)}€</strong>
                                <i class="fas fa-user text-gray-500 w-4 ml-3 mr-1"></i> Solo: <strong>${day.priceSolo.toFixed(2)}€</strong>
                            </p>
                            <p class="text-gray-600 text-sm">
                                <i class="fas fa-map-signs text-gray-500 w-4 mr-1"></i> GPX: <strong>${day.gpxFile || 'N/A'}</strong>
                            </p>
                        </div>
                        <div class="flex flex-col items-center gap-3 ml-4 shrink-0">
                             <button data-id="${day.id}" class="edit-day-btn text-blue-500 hover:text-blue-700 opacity-60 hover:opacity-100 transition-opacity" title="Modifier l'étape">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button data-day-id="${day.id}" 
                                    class="view-hotel-photos-btn relative text-indigo-600 hover:text-indigo-800 opacity-60 hover:opacity-100 transition-opacity ${hotelPhotosCount === 0 ? 'cursor-not-allowed opacity-30' : ''}"
                                    ${hotelPhotosCount === 0 ? 'disabled' : ''}
                                    title="Photos de l'hôtel (${hotelPhotosCount})">
                                <i class="fas fa-camera"></i>
                                ${hotelPhotosCount > 0 ? `<span class="absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold">${hotelPhotosCount}</span>` : ''}
                            </button>
                            <button data-id="${day.id}" class="reassign-day-btn text-green-600 hover:text-green-800 opacity-60 hover:opacity-100 transition-opacity" title="Copier/Déplacer l'étape">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button data-id="${day.id}" class="delete-day-btn text-red-500 hover:text-red-700 opacity-60 hover:opacity-100 transition-opacity" title="Supprimer l'étape">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    dayEl.querySelector('.delete-day-btn').addEventListener('click', () => deleteDay(day.id));
                    dayEl.querySelector('.edit-day-btn').addEventListener('click', () => openEditDayModal(day.id));
                    dayEl.querySelector('.reassign-day-btn').addEventListener('click', () => openReassignDayModal(day.id));
                    
                    // NOUVEAU : Listener pour le bouton photo
                    const photoBtn = dayEl.querySelector('.view-hotel-photos-btn');
                    if (photoBtn && hotelPhotosCount > 0) {
                        photoBtn.addEventListener('click', () => {
                            openHotelLightbox(day.id);
                        });
                    }
                    
                    daysListEl.appendChild(dayEl);
                });

                // Mise à jour du calculateur de coût
                updateCostCalculator();

            }, (error) => {
                console.error("Erreur lors du chargement des étapes:", error);
                showToast("Erreur de chargement des étapes", "error");
            });
        }

        /**
         * Calcule et met à jour les coûts du voyage
         */
        function updateCostCalculator() {
            // Calcul des totaux
            let totalDouble = 0;
            let totalSolo = 0;

            allDaysCache.forEach(day => {
                totalDouble += day.priceDouble || 0;
                totalSolo += day.priceSolo || 0;
            });

            // Calcul des coûts par personne
            const costDoublePerPerson = totalDouble / 2;

            // Récupération du prix de vente par personne saisi
            const salePricePerPerson = parseFloat(document.getElementById('sale-price-pp-input').value) || 0;

            // Calcul de la marge par personne
            const marginPerPerson = salePricePerPerson - costDoublePerPerson;
            
            // Calcul du pourcentage de marge
            const marginPercent = costDoublePerPerson > 0 ? (marginPerPerson / costDoublePerPerson) * 100 : 0;

            // Calcul des prix de vente totaux
            const saleDouble = salePricePerPerson * 2; // Prix de vente pour la chambre double
            const marginMultiplier = 1 + (marginPercent / 100);
            const saleSolo = totalSolo * marginMultiplier; // Applique le même % de marge au solo

            // Mise à jour de l'affichage
            document.getElementById('total-double').textContent = totalDouble.toFixed(2) + '€';
            document.getElementById('total-double-pp').textContent = costDoublePerPerson.toFixed(2) + '€';
            document.getElementById('total-solo').textContent = totalSolo.toFixed(2) + '€';
            document.getElementById('sale-double').textContent = saleDouble.toFixed(2) + '€';
            document.getElementById('sale-double-pp').textContent = salePricePerPerson.toFixed(2) + '€';
            document.getElementById('sale-solo').textContent = saleSolo.toFixed(2) + '€';
            
            // Affichage de la marge
            document.getElementById('margin-per-person').textContent = marginPerPerson.toFixed(2) + '€';
            document.getElementById('margin-percent').textContent = '(' + marginPercent.toFixed(1) + '%)';
        }
        
        /**
         * Gère l'ajout d'une nouvelle étape.
         */
        addDayForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !currentTripId) return;
            
            const editingDayId = document.getElementById('editing-day-id').value;

            const city = document.getElementById('day-city').value.trim();
            const hotelName = document.getElementById('day-hotel-name').value.trim();

            const nights = parseInt(document.getElementById('day-nights').value) || 1;

            const dayData = {
                dayName: document.getElementById('day-name').value.trim(),
                city: city,
                hotelName: hotelName,
                priceDouble: parseFloat(document.getElementById('day-price-double').value) || 0,
                priceSolo: parseFloat(document.getElementById('day-price-solo').value) || 0,
                nights: nights,
                gpxFile: document.getElementById('day-gpx-file').value.trim(),
                hotelLink: document.getElementById('day-hotel-link').value.trim(),
            };

            // Validation simple
            if (!dayData.dayName || !city || !hotelName) {
                showToast("Le 'Nom du Jour', 'Ville' et 'Nom de l'hôtel' sont obligatoires.", "error");
                return;
            }

            // Vérification des doublons de ville (sauf en mode édition sur la même étape)
            const duplicateCitySteps = allDaysCache.filter(d => 
                d.city && d.city.toLowerCase() === city.toLowerCase() && 
                (!editingDayId || d.id !== editingDayId)
            );
            
            if (duplicateCitySteps.length > 0) {
                const hotelsList = duplicateCitySteps.map(d => `"${d.hotelName}"`).join(', ');
                showToast(`⚠️ Attention : Vous avez déjà ${duplicateCitySteps.length} hôtel(s) à ${city} : ${hotelsList}`, "error");
                // On continue quand même l'enregistrement après l'avertissement
            }

            try {
                const daysCollectionPath = `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days`;
                if (editingDayId) {
                    // Mode Mise à jour
                    const dayDocRef = doc(db, daysCollectionPath, editingDayId);
                    await setDoc(dayDocRef, dayData, { merge: true }); // merge: true pour ne pas écraser createdAt
                    showToast("Étape mise à jour !", "success");
                } else {
                    // Mode Création
                    dayData.createdAt = serverTimestamp(); // Ajoute le timestamp seulement à la création
                    await addDoc(collection(db, daysCollectionPath), dayData);
                    showToast("Étape ajoutée !", "success");
                }
                
                addDayForm.reset();
                toggleModal(addDayModal, false);
            } catch (error) {
                console.error("Erreur lors de l'enregistrement de l'étape:", error);
                showToast("Erreur d'enregistrement de l'étape", "error");
            }
        });

        /**
         * Ouvre la modale d'ajout/édition en mode "Édition".
         */
        function openEditDayModal(dayId) {
            const day = allDaysCache.find(d => d.id === dayId);
            if (!day) return;

            // Pré-remplir le formulaire
            document.getElementById('editing-day-id').value = day.id;
            document.getElementById('day-name').value = day.dayName;
            document.getElementById('day-city').value = day.city || '';
            document.getElementById('day-hotel-name').value = day.hotelName;
            document.getElementById('day-price-double').value = day.priceDouble;
            document.getElementById('day-price-solo').value = day.priceSolo;
            document.getElementById('day-nights').value = day.nights || 1;
            document.getElementById('day-gpx-file').value = day.gpxFile;
            document.getElementById('day-hotel-link').value = day.hotelLink;

            // Adapter la modale
            addDayModalTitle.textContent = "Modifier l'étape";
            saveDayBtn.textContent = "Enregistrer les modifications";

            toggleModal(addDayModal, true);
        }

        /**
         * Ouvre la modale de ré-attribution d'étape.
         */
        async function openReassignDayModal(dayId) {
            stepToReassign = allDaysCache.find(d => d.id === dayId);
            if (!stepToReassign) return;

            reassignDayNameEl.textContent = stepToReassign.dayName;
            destinationTripSelect.innerHTML = '<option>Chargement des voyages...</option>';
            toggleModal(reassignDayModal, true);

            // Charger les autres voyages
            try {
                const tripsCollectionPath = `artifacts/${appId}/users/${userId}/trips`;
                const q = query(collection(db, tripsCollectionPath), orderBy("name"));
                const querySnapshot = await getDocs(q);
                
                destinationTripSelect.innerHTML = ''; // Nettoyer
                let hasTrips = false;
                querySnapshot.forEach(doc => {
                    if (doc.id !== currentTripId) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.data().name;
                        destinationTripSelect.appendChild(option);
                        hasTrips = true;
                    }
                });

                if (!hasTrips) {
                    destinationTripSelect.innerHTML = '<option value="">Aucun autre voyage disponible</option>';
                }
            } catch (error) {
                console.error("Erreur lors du chargement des voyages pour la ré-attribution:", error);
                destinationTripSelect.innerHTML = '<option value="">Erreur de chargement</option>';
            }
        }

        /**
         * Copie ou déplace une étape vers un autre voyage.
         */
        async function reassignDay(action) {
            const destinationTripId = destinationTripSelect.value;
            if (!destinationTripId || !stepToReassign) {
                showToast("Veuillez sélectionner un voyage de destination.", "error");
                return;
            }

            const { id, ...dayData } = stepToReassign; // Copie les données sans l'ID
            dayData.createdAt = serverTimestamp(); // Nouveau timestamp pour le tri

            const destinationPath = `artifacts/${appId}/users/${userId}/trips/${destinationTripId}/days`;
            
            // 1. Copier l'étape
            await addDoc(collection(db, destinationPath), dayData);

            // 2. Si c'est un déplacement, supprimer l'originale
            if (action === 'move') {
                const originalPath = `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days/${id}`;
                await deleteDoc(doc(db, originalPath));
            }

            toggleModal(reassignDayModal, false);
            showToast(`Étape ${action === 'move' ? 'déplacée' : 'copiée'} avec succès !`, "success");
            stepToReassign = null;
        }

        /**
         * Gère la suppression d'une étape.
         */
        async function deleteDay(dayId) {
            showDeleteConfirm("Voulez-vous vraiment supprimer cette étape ?", async () => {
                if (!userId || !currentTripId) return;
                try {
                    const dayDocPath = `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days/${dayId}`;
                    await deleteDoc(doc(db, dayDocPath));
                    showToast("Étape supprimée.", "success");
                } catch (error) {
                    console.error("Erreur lors de la suppression de l'étape:", error);
                    showToast("Erreur de suppression", "error");
                }
            });
        }
        
        /**
         * Génère la liste adaptée basée sur les cases cochées.
         */
        function generateAdaptedList() {
            const checkboxes = document.querySelectorAll('.adapter-check:checked');
            if (checkboxes.length === 0) {
                showToast("Veuillez sélectionner au moins une étape.", "error");
                return;
            }

            const listContentEl = document.getElementById('adapted-list-content');
            listContentEl.innerHTML = '';
            let stepCounter = 1;

            checkboxes.forEach(box => {
                const dayIndex = parseInt(box.dataset.dayIndex);
                const day = allDaysCache[dayIndex];
                
                const itemEl = document.createElement('div');
                itemEl.className = "border-b border-gray-200 pb-3";
                itemEl.innerHTML = `
                    <p class="font-semibold text-lg">Étape ${stepCounter} (${day.dayName}):</p> 
                    <ul class="list-disc list-inside ml-4 text-gray-800">
                        <li>Hôtel: ${day.hotelName} ${day.hotelLink ? `<a href="${day.hotelLink}" target="_blank" class="text-blue-500 hover:underline text-sm"><i class="fas fa-external-link-alt"></i></a>` : ''}</li>
                        <li>Prix: ${day.priceDouble.toFixed(2)}€ (Double) / ${day.priceSolo.toFixed(2)}€ (Solo)</li>
                        <li>GPX: ${day.gpxFile || 'N/A'}</li>
                    </ul>
                `;
                listContentEl.appendChild(itemEl);
                stepCounter++;
            });

            toggleModal(adaptedListModal, true);
        }

        // --- Listener pour l'extraction automatique depuis l'URL ---
        const hotelLinkInput = document.getElementById('day-hotel-link');
        hotelLinkInput.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url && url.includes('ratehawk.com')) {
                const parsed = parseRateHawkUrl(url);
                if (parsed) {
                    document.getElementById('day-city').value = parsed.city;
                    document.getElementById('day-hotel-name').value = parsed.hotelName;
                    showToast(`✨ Auto-rempli : ${parsed.city} - ${parsed.hotelName}`, "success");
                }
            }
        });

        // --- Listener pour le prix de vente par personne (recalcul en temps réel + sauvegarde) ---
        const salePricePPInput = document.getElementById('sale-price-pp-input');
        let saveSalePriceTimeout = null;
        
        salePricePPInput.addEventListener('input', () => {
            updateCostCalculator();
            
            // Sauvegarde automatique avec un délai (debounce)
            if (saveSalePriceTimeout) {
                clearTimeout(saveSalePriceTimeout);
            }
            
            saveSalePriceTimeout = setTimeout(async () => {
                if (currentTripId && userId) {
                    const salePricePP = parseFloat(salePricePPInput.value) || 0;
                    try {
                        const tripDocPath = `artifacts/${appId}/users/${userId}/trips/${currentTripId}`;
                        await setDoc(doc(db, tripDocPath), {
                            salePricePerPerson: salePricePP
                        }, { merge: true });
                        console.log('Prix de vente sauvegardé:', salePricePP);
                    } catch (error) {
                        console.error("Erreur lors de la sauvegarde du prix de vente:", error);
                    }
                }
            }, 1000); // Sauvegarde après 1 seconde d'inactivité
        });

        // --- Ajout des listeners pour les modales ---
        addDayModalBtn.addEventListener('click', () => {
            // Réinitialiser la modale pour le mode "Ajout"
            addDayForm.reset();
            document.getElementById('editing-day-id').value = '';
            addDayModalTitle.textContent = "Ajouter une nouvelle étape";
            saveDayBtn.textContent = "Enregistrer l'étape";
            toggleModal(addDayModal, true);
        });
        cancelAddDayBtn.addEventListener('click', () => {
            toggleModal(addDayModal, false);
        });

        // Listeners pour la modale de ré-attribution
        cancelReassignBtn.addEventListener('click', () => toggleModal(reassignDayModal, false));
        copyDayBtn.addEventListener('click', () => reassignDay('copy'));
        moveDayBtn.addEventListener('click', () => reassignDay('move'));

        // Ferme les modales en cliquant sur le fond
        [addDayModal, reassignDayModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                // Ferme la modale de ré-attribution
                if (e.target === reassignDayModal) {
                    toggleModal(reassignDayModal, false);
                    stepToReassign = null;
                    return;
                }
                // Ferme les autres modales
                if (e.target === modal) {
                    toggleModal(modal, false);
                }
            });
        });

        /**
         * Vérifie s'il y a des données dans le localStorage.
         */
        function checkForLocalStorageData() {
            try {
                const trips = localStorage.getItem('trips');
                const days = localStorage.getItem('days');
                
                if (trips || days) {
                    localStorageData = {
                        trips: trips ? JSON.parse(trips) : [],
                        days: days ? JSON.parse(days) : []
                    };
                    
                    // Affiche le banner seulement s'il y a des données
                    if (localStorageData.trips.length > 0 || localStorageData.days.length > 0) {
                        migrationBanner.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("Erreur lors de la lecture du localStorage:", error);
            }
        }

        /**
         * Ouvre la modale de migration et affiche le résumé.
         */
        function openMigrationModal() {
            if (!localStorageData) return;
            
            const tripsCount = localStorageData.trips.length;
            const daysCount = localStorageData.days.length;
            
            migrationSummary.innerHTML = `
                <div class="space-y-2">
                    <p class="font-semibold text-gray-700">
                        <i class="fas fa-suitcase text-blue-500 mr-2"></i>
                        ${tripsCount} voyage${tripsCount > 1 ? 's' : ''}
                    </p>
                    <p class="font-semibold text-gray-700">
                        <i class="fas fa-map-marker-alt text-green-500 mr-2"></i>
                        ${daysCount} étape${daysCount > 1 ? 's' : ''}
                    </p>
                </div>
            `;
            
            // Réinitialise l'état de la modale
            migrationContent.classList.remove('hidden');
            migrationProgress.classList.add('hidden');
            migrationSuccess.classList.add('hidden');
            confirmMigrationBtn.classList.remove('hidden');
            cancelMigrationBtn.classList.remove('hidden');
            closeMigrationBtn.classList.add('hidden');
            
            toggleModal(migrationModal, true);
        }

        /**
         * Effectue la migration des données localStorage vers Firebase.
         */
        async function performMigration() {
            if (!userId || !localStorageData) return;
            
            // Affiche la progression
            migrationContent.classList.add('hidden');
            migrationProgress.classList.remove('hidden');
            confirmMigrationBtn.classList.add('hidden');
            cancelMigrationBtn.classList.add('hidden');
            
            try {
                const tripsCollectionPath = `artifacts/${appId}/users/${userId}/trips`;
                
                // Map pour suivre les anciens IDs de voyages vers les nouveaux
                const tripIdMap = {};
                
                // 1. Migrer les voyages
                for (const trip of localStorageData.trips) {
                    const tripData = {
                        name: trip.name,
                        createdAt: serverTimestamp()
                    };
                    
                    const tripRef = await addDoc(collection(db, tripsCollectionPath), tripData);
                    tripIdMap[trip.id] = tripRef.id;
                }
                
                // 2. Migrer les étapes
                for (const day of localStorageData.days) {
                    const newTripId = tripIdMap[day.tripId];
                    if (!newTripId) continue; // Ignore si le voyage n'existe pas
                    
                    const daysCollectionPath = `artifacts/${appId}/users/${userId}/trips/${newTripId}/days`;
                    const dayData = {
                        dayName: day.dayName || day.name || 'Étape',
                        city: day.city || '',
                        hotelName: day.hotelName || day.hotel || '',
                        priceDouble: parseFloat(day.priceDouble) || 0,
                        priceSolo: parseFloat(day.priceSolo) || 0,
                        nights: parseInt(day.nights) || 1,
                        gpxFile: day.gpxFile || day.gpx || '',
                        hotelLink: day.hotelLink || day.link || '',
                        createdAt: serverTimestamp()
                    };
                    
                    await addDoc(collection(db, daysCollectionPath), dayData);
                }
                
                // Migration réussie
                migrationProgress.classList.add('hidden');
                migrationSuccess.classList.remove('hidden');
                closeMigrationBtn.classList.remove('hidden');
                
                // Cache le banner
                migrationBanner.classList.add('hidden');
                
                // Optionnel: Nettoyer le localStorage après migration réussie
                // localStorage.removeItem('trips');
                // localStorage.removeItem('days');
                // localStorageData = null;
                
                showToast("Migration réussie ! Vos données sont maintenant sur Firebase.", "success");
                
            } catch (error) {
                console.error("Erreur lors de la migration:", error);
                showToast("Erreur lors de la migration", "error");
                
                // Réaffiche le contenu initial en cas d'erreur
                migrationProgress.classList.add('hidden');
                migrationContent.classList.remove('hidden');
                confirmMigrationBtn.classList.remove('hidden');
                cancelMigrationBtn.classList.remove('hidden');
            }
        }

        /**
         * Charge le code d'accès associé à l'userId depuis Firebase ou localStorage
         */
        async function loadAccessCode() {
            try {
                // D'abord vérifie dans localStorage
                const storedCode = localStorage.getItem('accessCode');
                if (storedCode) {
                    accessCodeDisplay.textContent = storedCode;
                    return;
                }
                
                // Sinon cherche dans Firebase
                const codesCollectionPath = `artifacts/${appId}/accessCodes`;
                const q = query(collection(db, codesCollectionPath));
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach(doc => {
                    if (doc.data().userId === userId) {
                        const code = doc.id; // L'ID du document est le code
                        accessCodeDisplay.textContent = code;
                        localStorage.setItem('accessCode', code);
                    }
                });
            } catch (error) {
                console.error("Erreur lors du chargement du code d'accès:", error);
            }
        }

        /**
         * Configure un nouveau code d'accès pour l'utilisateur
         */
        async function setupAccessCode() {
            const code = newAccessCodeInput.value.trim();
            
            if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                showToast("Le code doit contenir exactement 6 chiffres.", "error");
                return;
            }
            
            try {
                // Vérifie si le code existe déjà
                const codesCollectionPath = `artifacts/${appId}/accessCodes`;
                const codeDocRef = doc(db, codesCollectionPath, code);
                const codeDoc = await getDoc(codeDocRef);
                
                if (codeDoc.exists()) {
                    showToast("Ce code est déjà utilisé. Choisissez-en un autre.", "error");
                    return;
                }
                
                // Sauvegarde le code dans Firebase
                await setDoc(codeDocRef, {
                    userId: userId,
                    createdAt: serverTimestamp()
                });
                
                // Sauvegarde également dans localStorage
                localStorage.setItem('accessCode', code);
                localStorage.setItem('savedUserId', userId);
                
                accessCodeDisplay.textContent = code;
                showToast("Code d'accès configuré avec succès !", "success");
                toggleModal(codeSetupModal, false);
                
            } catch (error) {
                console.error("Erreur lors de la configuration du code:", error);
                showToast("Erreur lors de la configuration du code", "error");
            }
        }

        /**
         * Se connecte avec un code d'accès existant
         */
        async function loginWithCode() {
            const code = enterAccessCodeInput.value.trim();
            
            if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                showToast("Le code doit contenir exactement 6 chiffres.", "error");
                return;
            }
            
            try {
                // Cherche le userId associé au code
                const codesCollectionPath = `artifacts/${appId}/accessCodes`;
                const codeDocRef = doc(db, codesCollectionPath, code);
                const codeDoc = await getDoc(codeDocRef);
                
                if (!codeDoc.exists()) {
                    showToast("Code incorrect. Vérifiez et réessayez.", "error");
                    return;
                }
                
                const associatedUserId = codeDoc.data().userId;
                
                // Sauvegarde l'userId et le code dans localStorage
                localStorage.setItem('savedUserId', associatedUserId);
                localStorage.setItem('accessCode', code);
                
                showToast("Connexion réussie ! Rechargement...", "success");
                toggleModal(useCodeModal, false);
                
                // Recharge la page pour utiliser le nouvel userId
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error("Erreur lors de la connexion avec le code:", error);
                showToast("Erreur de connexion", "error");
            }
        }

        // Listeners pour le système de code d'accès
        showCodeSetupBtn.addEventListener('click', () => {
            newAccessCodeInput.value = '120584'; // Pré-rempli avec le code demandé
            toggleModal(codeSetupModal, true);
        });
        
        useCodeBtn.addEventListener('click', () => {
            enterAccessCodeInput.value = '';
            toggleModal(useCodeModal, true);
        });
        
        cancelCodeSetupBtn.addEventListener('click', () => {
            toggleModal(codeSetupModal, false);
        });
        
        confirmCodeSetupBtn.addEventListener('click', setupAccessCode);
        
        cancelUseCodeBtn.addEventListener('click', () => {
            toggleModal(useCodeModal, false);
        });
        
        confirmUseCodeBtn.addEventListener('click', loginWithCode);
        
        codeSetupModal.addEventListener('click', (e) => {
            if (e.target === codeSetupModal) {
                toggleModal(codeSetupModal, false);
            }
        });
        
        useCodeModal.addEventListener('click', (e) => {
            if (e.target === useCodeModal) {
                toggleModal(useCodeModal, false);
            }
        });

        // Listeners pour la migration
        migrateDataBtn.addEventListener('click', openMigrationModal);
        cancelMigrationBtn.addEventListener('click', () => toggleModal(migrationModal, false));
        confirmMigrationBtn.addEventListener('click', performMigration);
        closeMigrationBtn.addEventListener('click', () => {
            toggleModal(migrationModal, false);
            // Recharge les voyages pour afficher les données migrées
            if (currentTripId) {
                selectTrip(currentTripId, currentTripName);
            }
        });
        
        migrationModal.addEventListener('click', (e) => {
            if (e.target === migrationModal && !migrationProgress.classList.contains('hidden')) {
                // Ne pas fermer pendant la migration
                return;
            }
            if (e.target === migrationModal) {
                toggleModal(migrationModal, false);
            }
        });

        /**
         * Récupère tous les hôtels de tous les voyages de l'utilisateur
         */
        async function getAllUserHotels() {
            if (!userId) return [];
            
            const tripsCollectionPath = `artifacts/${appId}/users/${userId}/trips`;
            const tripsQuery = query(collection(db, tripsCollectionPath));
            const tripsSnapshot = await getDocs(tripsQuery);
            
            const hotels = [];
            
            // Pour chaque voyage, récupère les étapes
            for (const tripDoc of tripsSnapshot.docs) {
                const tripId = tripDoc.id;
                const tripName = tripDoc.data().name;
                const daysCollectionPath = `artifacts/${appId}/users/${userId}/trips/${tripId}/days`;
                const daysQuery = query(collection(db, daysCollectionPath));
                const daysSnapshot = await getDocs(daysQuery);
                
                daysSnapshot.forEach(dayDoc => {
                    const day = dayDoc.data();
                    if (day.city && day.hotelName) {
                        hotels.push({
                            ...day,
                            tripId: tripId,
                            tripName: tripName,
                            dayId: dayDoc.id
                        });
                    }
                });
            }
            
            return hotels;
        }

        /**
         * Calcule la distance entre deux coordonnées (en km)
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        /**
         * Géolocalise une ville avec Google Maps Geocoding API
         */
        async function geocodeCity(cityName) {
            return new Promise((resolve, reject) => {
                const geocoder = new google.maps.Geocoder();
                // Ne pas ajouter de pays spécifique pour couvrir toute l'Europe
                geocoder.geocode({ 'address': cityName }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng(),
                            formattedAddress: results[0].formatted_address
                        });
                    } else {
                        reject(new Error('Ville non trouvée'));
                    }
                });
            });
        }

        /**
         * Recherche les hôtels à proximité d'une ville
         */
        async function searchNearbyHotels() {
            const cityInput = document.getElementById('search-city-input');
            const searchLoader = document.getElementById('search-loader');
            const searchResults = document.getElementById('search-results');
            const noResults = document.getElementById('no-results');
            const resultsList = document.getElementById('results-list');
            const cityName = cityInput.value.trim();
            
            if (!cityName) {
                showToast("Veuillez entrer un nom de ville.", "error");
                return;
            }
            
            // Affiche le loader
            searchLoader.classList.remove('hidden');
            searchResults.classList.add('hidden');
            noResults.classList.add('hidden');
            
            try {
                // 1. Géolocalise la ville recherchée
                const searchLocation = await geocodeCity(cityName);
                
                // 2. Récupère tous les hôtels de l'utilisateur
                const allHotels = await getAllUserHotels();
                
                if (allHotels.length === 0) {
                    searchLoader.classList.add('hidden');
                    noResults.classList.remove('hidden');
                    return;
                }
                
                // 3. Pour chaque hôtel, géolocalise et calcule la distance
                const hotelsWithDistance = [];
                
                for (const hotel of allHotels) {
                    try {
                        const hotelLocation = await geocodeCity(hotel.city);
                        const distance = calculateDistance(
                            searchLocation.lat,
                            searchLocation.lng,
                            hotelLocation.lat,
                            hotelLocation.lng
                        );
                        
                        // Vérifie que la distance est valide et dans le rayon de 20km
                        if (!isNaN(distance) && distance >= 0 && distance <= 20) {
                            hotelsWithDistance.push({
                                ...hotel,
                                distance: distance,
                                location: hotelLocation
                            });
                        }
                    } catch (error) {
                        console.log(`Impossible de géolocaliser ${hotel.city}:`, error.message);
                        // Ne pas ajouter l'hôtel si la géolocalisation échoue
                    }
                }
                
                // 4. Affiche les résultats
                searchLoader.classList.add('hidden');
                
                if (hotelsWithDistance.length === 0) {
                    noResults.classList.remove('hidden');
                } else {
                    // Trie par distance
                    hotelsWithDistance.sort((a, b) => a.distance - b.distance);
                    
                    resultsList.innerHTML = '';
                    hotelsWithDistance.forEach(hotel => {
                        const resultEl = document.createElement('div');
                        resultEl.className = 'bg-gray-50 p-4 rounded-lg hover:bg-gray-100 cursor-pointer border border-gray-200 transition-colors';
                        resultEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h5 class="font-semibold text-gray-900">${hotel.hotelName}</h5>
                                    <p class="text-sm text-gray-600">
                                        <i class="fas fa-map-marker-alt mr-1"></i>${hotel.city}
                                        <span class="ml-3 text-indigo-600 font-semibold">${hotel.distance.toFixed(1)} km</span>
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-suitcase mr-1"></i>Voyage: ${hotel.tripName}
                                    </p>
                                    <p class="text-xs text-gray-600 mt-1">
                                        Prix: ${hotel.priceDouble.toFixed(2)}€ (Double) / ${hotel.priceSolo.toFixed(2)}€ (Solo)
                                    </p>
                                </div>
                                <button class="ml-4 bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">
                                    <i class="fas fa-check mr-1"></i>Utiliser
                                </button>
                            </div>
                        `;
                        
                        // Listener pour utiliser cet hôtel
                        resultEl.querySelector('button').addEventListener('click', () => {
                            useSelectedHotel(hotel);
                        });
                        
                        resultsList.appendChild(resultEl);
                    });
                    
                    searchResults.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error("Erreur lors de la recherche:", error);
                searchLoader.classList.add('hidden');
                showToast("Ville introuvable. Vérifiez l'orthographe.", "error");
            }
        }

        /**
         * Utilise un hôtel sélectionné pour pré-remplir le formulaire
         */
        function useSelectedHotel(hotel) {
            // Ferme la modale de recherche
            toggleModal(document.getElementById('nearby-hotels-modal'), false);
            
            // Pré-remplit les champs du formulaire
            document.getElementById('day-city').value = hotel.city;
            document.getElementById('day-hotel-name').value = hotel.hotelName;
            document.getElementById('day-price-double').value = hotel.priceDouble;
            document.getElementById('day-price-solo').value = hotel.priceSolo;
            document.getElementById('day-hotel-link').value = hotel.hotelLink || '';
            
            showToast(`✨ Hôtel sélectionné : ${hotel.hotelName} à ${hotel.city}`, "success");
        }

        // Listeners pour la recherche d'hôtels à proximité
        const searchNearbyHotelsBtn = document.getElementById('search-nearby-hotels-btn');
        const nearbyHotelsModal = document.getElementById('nearby-hotels-modal');
        const closeNearbyHotelsBtn = document.getElementById('close-nearby-hotels-btn');
        const performSearchBtn = document.getElementById('perform-search-btn');
        const searchCityInput = document.getElementById('search-city-input');
        
        // Variable pour stocker l'autocomplétion
        let searchCityAutocomplete = null;
        
        searchNearbyHotelsBtn.addEventListener('click', () => {
            // Réinitialise la modale
            document.getElementById('search-city-input').value = '';
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('no-results').classList.add('hidden');
            document.getElementById('search-loader').classList.add('hidden');
            
            toggleModal(nearbyHotelsModal, true);
            
            // Initialise l'autocomplétion Google Places si pas encore fait
            if (!searchCityAutocomplete) {
                searchCityAutocomplete = new google.maps.places.Autocomplete(searchCityInput, {
                    types: ['(cities)']
                    // Pas de restriction géographique pour couvrir toute l'Europe
                });
                
                // Listener pour quand un lieu est sélectionné
                searchCityAutocomplete.addListener('place_changed', () => {
                    const place = searchCityAutocomplete.getPlace();
                    if (place.geometry) {
                        // Auto-lance la recherche après sélection
                        setTimeout(() => {
                            performSearchBtn.click();
                        }, 100);
                    }
                });
            }
        });
        
        closeNearbyHotelsBtn.addEventListener('click', () => {
            toggleModal(nearbyHotelsModal, false);
        });
        
        performSearchBtn.addEventListener('click', searchNearbyHotels);
        
        // Recherche aussi avec la touche Entrée
        searchCityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchNearbyHotels();
            }
        });
        
        nearbyHotelsModal.addEventListener('click', (e) => {
            if (e.target === nearbyHotelsModal) {
                toggleModal(nearbyHotelsModal, false);
            }
        });

        // --- Listener pour le bouton d'ouverture de l'URL de l'hôtel ---
        const openHotelLinkBtn = document.getElementById('open-hotel-link-btn');
        openHotelLinkBtn.addEventListener('click', () => {
            const url = document.getElementById('day-hotel-link').value.trim();
            if (url) {
                try {
                    // Ajoute https:// si manquant pour que le lien s'ouvre correctement
                    const fullUrl = url.startsWith('http') ? url : `https://${url}`;
                    window.open(fullUrl, '_blank');
                } catch (e) {
                    showToast("L'URL semble invalide.", "error");
                }
            }
        });

        // --- Gestion de l'URL de la liste RateHawk ---
        const encodeHotelListBtn = document.getElementById('encode-hotel-list-btn');
        const viewHotelListBtn = document.getElementById('view-hotel-list-btn');
        const encodeHotelListModal = document.getElementById('encode-hotel-list-modal');
        const cancelEncodeHotelListBtn = document.getElementById('cancel-encode-hotel-list-btn');
        const saveHotelListUrlBtn = document.getElementById('save-hotel-list-url-btn');
        const ratehawkUrlInput = document.getElementById('ratehawk-url-input');
        
        let currentRatehawkUrl = null;
        
        // Ouvre la modale pour encoder l'URL RateHawk
        encodeHotelListBtn.addEventListener('click', () => {
            ratehawkUrlInput.value = currentRatehawkUrl || '';
            toggleModal(encodeHotelListModal, true);
        });
        
        // Annule l'encodage
        cancelEncodeHotelListBtn.addEventListener('click', () => {
            toggleModal(encodeHotelListModal, false);
        });
        
        // Sauvegarde l'URL RateHawk
        saveHotelListUrlBtn.addEventListener('click', async () => {
            const url = ratehawkUrlInput.value.trim();
            
            if (!url) {
                showToast("Veuillez entrer une URL.", "error");
                return;
            }
            
            if (!userId || !currentTripId) {
                showToast("Erreur: Voyage non sélectionné.", "error");
                return;
            }
            
            try {
                const tripDocPath = `artifacts/${appId}/users/${userId}/trips/${currentTripId}`;
                await setDoc(doc(db, tripDocPath), {
                    ratehawkListUrl: url
                }, { merge: true });
                
                currentRatehawkUrl = url;
                viewHotelListBtn.disabled = false;
                
                showToast("URL de la liste RateHawk enregistrée !", "success");
                toggleModal(encodeHotelListModal, false);
            } catch (error) {
                console.error("Erreur lors de la sauvegarde de l'URL:", error);
                showToast("Erreur lors de la sauvegarde.", "error");
            }
        });
        
        // Ouvre l'URL RateHawk dans un nouvel onglet
        viewHotelListBtn.addEventListener('click', () => {
            if (currentRatehawkUrl) {
                try {
                    const fullUrl = currentRatehawkUrl.startsWith('http') ? currentRatehawkUrl : `https://${currentRatehawkUrl}`;
                    window.open(fullUrl, '_blank');
                } catch (e) {
                    showToast("Erreur lors de l'ouverture de l'URL.", "error");
                }
            }
        });
        
        // Ferme la modale en cliquant sur le fond
        encodeHotelListModal.addEventListener('click', (e) => {
            if (e.target === encodeHotelListModal) {
                toggleModal(encodeHotelListModal, false);
            }
        });

        // ============================================
        // FONCTIONS SYSTÈME DE MÉDIAS
        // ============================================

        /**
         * Ouvre la modale de gestion des médias
         */
        function openMediaManager() {
            if (!currentTripId || !currentTripName) {
                showToast("Veuillez sélectionner un voyage d'abord.", "error");
                return;
            }
            
            document.getElementById('media-trip-name').textContent = currentTripName;
            toggleModal(document.getElementById('media-manager-modal'), true);
            
            // Charge les données de l'onglet actif (par défaut: Général)
            loadGeneralPhotos();
            loadPopularTags();
            updateSpaceMonitoring();
        }

        /**
         * Gestion des onglets Général / Hôtels
         */
        function switchTab(tabName) {
            const tabGeneralBtn = document.getElementById('tab-general-btn');
            const tabHotelsBtn = document.getElementById('tab-hotels-btn');
            const tabGeneralContent = document.getElementById('tab-general-content');
            const tabHotelsContent = document.getElementById('tab-hotels-content');
            
            if (tabName === 'general') {
                tabGeneralBtn.classList.add('border-purple-600', 'text-gray-900');
                tabGeneralBtn.classList.remove('border-transparent', 'text-gray-600');
                tabHotelsBtn.classList.remove('border-purple-600', 'text-gray-900');
                tabHotelsBtn.classList.add('border-transparent', 'text-gray-600');
                
                tabGeneralContent.classList.remove('hidden');
                tabHotelsContent.classList.add('hidden');
                
                loadGeneralPhotos();
            } else {
                tabHotelsBtn.classList.add('border-purple-600', 'text-gray-900');
                tabHotelsBtn.classList.remove('border-transparent', 'text-gray-600');
                tabGeneralBtn.classList.remove('border-purple-600', 'text-gray-900');
                tabGeneralBtn.classList.add('border-transparent', 'text-gray-600');
                
                tabHotelsContent.classList.remove('hidden');
                tabGeneralContent.classList.add('hidden');
                
                loadHotelPhotos();
            }
        }

        /**
         * Gère le clic sur "Ajouter des photos (cols, routes)"
         */
        function handleGeneralUploadClick() {
            document.getElementById('upload-general-input').click();
        }

        /**
         * Gère la sélection de fichiers pour upload général
         */
        function handleGeneralFilesSelected(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            selectedFilesGeneral = files;
            
            // Affiche la modale de tagging
            document.getElementById('files-count').textContent = files.length;
            document.getElementById('tags-input').value = '';
            
            // Charge les tags suggérés
            loadSuggestedTags();
            
            toggleModal(document.getElementById('tagging-modal'), true);
        }

        /**
         * Charge les tags suggérés (tags populaires du voyage)
         */
        async function loadSuggestedTags() {
            const suggestedTagsContainer = document.getElementById('suggested-tags');
            suggestedTagsContainer.innerHTML = '';
            
            try {
                const mediaQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                    where('type', '==', 'general')
                );
                
                const snapshot = await getDocs(mediaQuery);
                const tagsCount = {};
                
                snapshot.forEach(doc => {
                    const tags = doc.data().tags || [];
                    tags.forEach(tag => {
                        tagsCount[tag] = (tagsCount[tag] || 0) + 1;
                    });
                });
                
                // Trie par popularité et affiche les 6 premiers
                const sortedTags = Object.entries(tagsCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6)
                    .map(([tag]) => tag);
                
                sortedTags.forEach(tag => {
                    const tagBtn = document.createElement('button');
                    tagBtn.type = 'button';
                    tagBtn.className = 'bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm hover:bg-purple-200 transition-colors';
                    tagBtn.textContent = tag;
                    tagBtn.addEventListener('click', () => {
                        const input = document.getElementById('tags-input');
                        const currentTags = input.value.split(',').map(t => t.trim()).filter(t => t);
                        if (!currentTags.includes(tag)) {
                            currentTags.push(tag);
                            input.value = currentTags.join(', ');
                        }
                    });
                    suggestedTagsContainer.appendChild(tagBtn);
                });
                
            } catch (error) {
                console.error("Erreur lors du chargement des tags suggérés:", error);
            }
        }

        /**
         * Confirme l'upload des photos générales avec les tags
         */
        async function confirmGeneralUpload() {
            const tagsInput = document.getElementById('tags-input').value.trim();
            
            if (!tagsInput) {
                showToast("Veuillez ajouter au moins un tag.", "error");
                return;
            }
            
            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
            
            if (tags.length === 0) {
                showToast("Veuillez ajouter au moins un tag valide.", "error");
                return;
            }
            
            // Désactive les boutons
            document.getElementById('confirm-upload-general-btn').disabled = true;
            document.getElementById('cancel-tagging-btn').disabled = true;
            
            // Affiche la barre de progression
            const progressContainer = document.getElementById('upload-progress-container');
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            progressContainer.classList.remove('hidden');
            
            try {
                const totalFiles = selectedFilesGeneral.length;
                let uploadedFiles = 0;
                
                for (const file of selectedFilesGeneral) {
                    // Upload vers Storage
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const storageRef = ref(storage, `users/${userId}/trips/${currentTripId}/general/${fileName}`);
                    
                    await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    // Enregistre dans Firestore
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`), {
                        type: 'general',
                        fileName: file.name,
                        storagePath: storageRef.fullPath,
                        downloadURL: downloadURL,
                        tags: tags,
                        fileSize: file.size,
                        uploadedAt: serverTimestamp()
                    });
                    
                    uploadedFiles++;
                    const progress = Math.round((uploadedFiles / totalFiles) * 100);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                }
                
                showToast(`${totalFiles} photo(s) uploadée(s) avec succès !`, "success");
                
                // Ferme la modale
                toggleModal(document.getElementById('tagging-modal'), false);
                
                // Recharge la galerie
                loadGeneralPhotos();
                loadPopularTags();
                updateSpaceMonitoring();
                
                // Réinitialise
                selectedFilesGeneral = [];
                document.getElementById('upload-general-input').value = '';
                
            } catch (error) {
                console.error("Erreur lors de l'upload:", error);
                showToast("Erreur lors de l'upload des photos.", "error");
            } finally {
                // Réactive les boutons
                document.getElementById('confirm-upload-general-btn').disabled = false;
                document.getElementById('cancel-tagging-btn').disabled = false;
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        }

        /**
         * Charge et affiche les photos générales (cols/routes)
         */
        async function loadGeneralPhotos(filterTag = null) {
            const gridContainer = document.getElementById('general-photos-grid');
            const noPhotosMessage = document.getElementById('no-general-photos');
            
            gridContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">Chargement...</p>';
            
            try {
                let mediaQuery;
                
                if (filterTag) {
                    mediaQuery = query(
                        collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                        where('type', '==', 'general'),
                        where('tags', 'array-contains', filterTag),
                        orderBy('uploadedAt', 'desc')
                    );
                } else {
                    mediaQuery = query(
                        collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                        where('type', '==', 'general'),
                        orderBy('uploadedAt', 'desc')
                    );
                }
                
                const snapshot = await getDocs(mediaQuery);
                
                if (snapshot.empty) {
                    gridContainer.innerHTML = '';
                    noPhotosMessage.classList.remove('hidden');
                    return;
                }
                
                noPhotosMessage.classList.add('hidden');
                gridContainer.innerHTML = '';
                allGeneralPhotos = [];
                
                snapshot.forEach(doc => {
                    const photo = { id: doc.id, ...doc.data() };
                    allGeneralPhotos.push(photo);
                    
                    const photoCard = document.createElement('div');
                    photoCard.className = 'relative group bg-gray-100 rounded-lg overflow-hidden aspect-square';
                    photoCard.innerHTML = `
                        <img src="${photo.downloadURL}" 
                             alt="${photo.fileName}" 
                             class="w-full h-full object-cover">
                        
                        <!-- Overlay avec tags -->
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">
                            <div class="flex flex-wrap gap-1">
                                ${photo.tags.map(tag => `
                                    <span class="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Boutons d'action (visibles au hover) -->
                        <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="download-photo-btn bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 rounded-full flex items-center justify-center"
                                    data-url="${photo.downloadURL}"
                                    data-filename="${photo.fileName}"
                                    title="Télécharger">
                                <i class="fas fa-download text-xs"></i>
                            </button>
                            <button class="delete-photo-btn bg-red-600 hover:bg-red-700 text-white w-8 h-8 rounded-full flex items-center justify-center"
                                    data-id="${photo.id}"
                                    data-path="${photo.storagePath}"
                                    title="Supprimer">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    `;
                    
                    gridContainer.appendChild(photoCard);
                });
                
                // Ajoute les listeners sur les boutons
                document.querySelectorAll('.download-photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        downloadPhoto(btn.dataset.url, btn.dataset.filename);
                    });
                });
                
                document.querySelectorAll('.delete-photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deletePhoto(btn.dataset.id, btn.dataset.path, 'general');
                    });
                });
                
            } catch (error) {
                console.error("Erreur lors du chargement des photos:", error);
                gridContainer.innerHTML = '<p class="col-span-full text-center text-red-500">Erreur de chargement</p>';
            }
        }

        /**
         * Charge les tags populaires pour le filtre
         */
        async function loadPopularTags() {
            const container = document.getElementById('popular-tags-container');
            container.innerHTML = '';
            
            try {
                const mediaQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                    where('type', '==', 'general')
                );
                
                const snapshot = await getDocs(mediaQuery);
                const tagsCount = {};
                
                snapshot.forEach(doc => {
                    const tags = doc.data().tags || [];
                    tags.forEach(tag => {
                        tagsCount[tag] = (tagsCount[tag] || 0) + 1;
                    });
                });
                
                // Trie par popularité
                const sortedTags = Object.entries(tagsCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sortedTags.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Aucun tag pour le moment</p>';
                    return;
                }
                
                sortedTags.forEach(([tag, count]) => {
                    const tagBtn = document.createElement('button');
                    tagBtn.type = 'button';
                    tagBtn.className = 'bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm hover:bg-purple-200 transition-colors flex items-center gap-2';
                    tagBtn.innerHTML = `
                        ${tag}
                        <span class="bg-purple-300 text-purple-900 px-1.5 py-0.5 rounded-full text-xs font-bold">${count}</span>
                    `;
                    tagBtn.addEventListener('click', () => {
                        document.getElementById('search-tags-input').value = tag;
                        loadGeneralPhotos(tag);
                    });
                    container.appendChild(tagBtn);
                });
                
            } catch (error) {
                console.error("Erreur lors du chargement des tags:", error);
            }
        }

        /**
         * Gère le clic sur "Ajouter photos d'hôtel"
         */
        function handleHotelUploadClick() {
            document.getElementById('upload-hotel-input').click();
        }

        /**
         * Gère la sélection de fichiers pour upload hôtel
         */
        function handleHotelFilesSelected(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            selectedFilesHotel = files;
            
            // Affiche la modale de sélection d'hôtel
            document.getElementById('hotel-files-count').textContent = files.length;
            
            // Charge la liste des hôtels
            loadHotelsForSelection();
            
            toggleModal(document.getElementById('hotel-selection-modal'), true);
        }

        /**
         * Charge la liste des hôtels/étapes pour la sélection
         */
        async function loadHotelsForSelection() {
            const listContainer = document.getElementById('hotels-list-selection');
            listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Chargement des hôtels...</p>';
            
            try {
                // Récupère toutes les étapes du voyage
                const daysQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days`),
                    orderBy('createdAt')
                );
                
                const snapshot = await getDocs(daysQuery);
                
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Aucune étape dans ce voyage</p>';
                    return;
                }
                
                listContainer.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const day = doc.data();
                    const hotelOption = document.createElement('div');
                    hotelOption.className = 'hotel-option border border-gray-300 rounded-md p-3 cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-colors';
                    hotelOption.dataset.dayId = doc.id;
                    hotelOption.dataset.hotelName = day.hotelName;
                    hotelOption.dataset.dayName = day.dayName;
                    hotelOption.dataset.city = day.city || '';
                    hotelOption.innerHTML = `
                        <p class="font-semibold text-gray-900">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                            ${day.dayName}${day.city ? ' • ' + day.city : ''}
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            <i class="fas fa-hotel text-gray-400 mr-2"></i>
                            ${day.hotelName}
                        </p>
                    `;
                    
                    hotelOption.addEventListener('click', () => {
                        // Désélectionne tous
                        document.querySelectorAll('.hotel-option').forEach(opt => {
                            opt.classList.remove('bg-blue-100', 'border-blue-500');
                            opt.classList.add('border-gray-300');
                        });
                        
                        // Sélectionne celui-ci
                        hotelOption.classList.add('bg-blue-100', 'border-blue-500');
                        hotelOption.classList.remove('border-gray-300');
                        
                        // Stocke la sélection
                        selectedHotelForUpload = {
                            dayId: doc.id,
                            hotelName: day.hotelName,
                            dayName: day.dayName
                        };
                        
                        // Active le bouton d'upload
                        document.getElementById('confirm-upload-hotel-btn').disabled = false;
                    });
                    
                    listContainer.appendChild(hotelOption);
                });
                
            } catch (error) {
                console.error("Erreur lors du chargement des hôtels:", error);
                listContainer.innerHTML = '<p class="text-center text-red-500 py-4">Erreur de chargement</p>';
            }
        }

        /**
         * Confirme l'upload des photos d'hôtel
         */
        async function confirmHotelUpload() {
            if (!selectedHotelForUpload) {
                showToast("Veuillez sélectionner un hôtel.", "error");
                return;
            }
            
            // Désactive les boutons
            document.getElementById('confirm-upload-hotel-btn').disabled = true;
            document.getElementById('cancel-hotel-selection-btn').disabled = true;
            
            // Affiche la barre de progression
            const progressContainer = document.getElementById('upload-hotel-progress-container');
            const progressBar = document.getElementById('upload-hotel-progress-bar');
            const progressText = document.getElementById('upload-hotel-progress-text');
            progressContainer.classList.remove('hidden');
            
            try {
                const totalFiles = selectedFilesHotel.length;
                let uploadedFiles = 0;
                
                for (const file of selectedFilesHotel) {
                    // Upload vers Storage
                    const timestamp = Date.now();
                    const fileName = `${timestamp}_${file.name}`;
                    const storageRef = ref(storage, `users/${userId}/trips/${currentTripId}/hotels/${selectedHotelForUpload.dayId}/${fileName}`);
                    
                    await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(storageRef);
                    
                    // Enregistre dans Firestore
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`), {
                        type: 'hotel',
                        fileName: file.name,
                        storagePath: storageRef.fullPath,
                        downloadURL: downloadURL,
                        linkedDayId: selectedHotelForUpload.dayId,
                        linkedHotelName: selectedHotelForUpload.hotelName,
                        fileSize: file.size,
                        uploadedAt: serverTimestamp()
                    });
                    
                    uploadedFiles++;
                    const progress = Math.round((uploadedFiles / totalFiles) * 100);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                }
                
                showToast(`${totalFiles} photo(s) d'hôtel uploadée(s) avec succès !`, "success");
                
                // Ferme la modale
                toggleModal(document.getElementById('hotel-selection-modal'), false);
                
                // Recharge les données
                loadHotelPhotos();
                updateSpaceMonitoring();
                
                // Recharge les badges des étapes
                loadDays();
                
                // Réinitialise
                selectedFilesHotel = [];
                selectedHotelForUpload = null;
                document.getElementById('upload-hotel-input').value = '';
                
            } catch (error) {
                console.error("Erreur lors de l'upload:", error);
                showToast("Erreur lors de l'upload des photos d'hôtel.", "error");
            } finally {
                // Réactive les boutons
                document.getElementById('confirm-upload-hotel-btn').disabled = false;
                document.getElementById('cancel-hotel-selection-btn').disabled = false;
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        }

        /**
         * Charge et affiche les photos d'hôtels groupées par étape
         */
        async function loadHotelPhotos(filterHotelName = null) {
            const listContainer = document.getElementById('hotels-photos-list');
            const noPhotosMessage = document.getElementById('no-hotel-photos');
            
            listContainer.innerHTML = '<p class="text-center text-gray-500">Chargement...</p>';
            
            try {
                const mediaQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                    where('type', '==', 'hotel'),
                    orderBy('uploadedAt', 'desc')
                );
                
                const snapshot = await getDocs(mediaQuery);
                
                if (snapshot.empty) {
                    listContainer.innerHTML = '';
                    noPhotosMessage.classList.remove('hidden');
                    return;
                }
                
                noPhotosMessage.classList.add('hidden');
                listContainer.innerHTML = '';
                allHotelPhotos = [];
                
                // Groupe les photos par dayId
                const photosByDay = {};
                
                snapshot.forEach(doc => {
                    const photo = { id: doc.id, ...doc.data() };
                    allHotelPhotos.push(photo);
                    
                    // Filtre si nécessaire
                    if (filterHotelName && !photo.linkedHotelName.toLowerCase().includes(filterHotelName.toLowerCase())) {
                        return;
                    }
                    
                    if (!photosByDay[photo.linkedDayId]) {
                        photosByDay[photo.linkedDayId] = {
                            hotelName: photo.linkedHotelName,
                            photos: []
                        };
                    }
                    photosByDay[photo.linkedDayId].photos.push(photo);
                });
                
                // Affiche chaque groupe
                for (const [dayId, data] of Object.entries(photosByDay)) {
                    const hotelSection = document.createElement('div');
                    hotelSection.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
                    
                    // Récupère les infos de l'étape
                    const dayDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days/${dayId}`));
                    const dayData = dayDoc.exists() ? dayDoc.data() : { dayName: 'Étape inconnue', city: '' };
                    
                    hotelSection.innerHTML = `
                        <div class="mb-3">
                            <h4 class="font-semibold text-lg text-gray-900">
                                <i class="fas fa-map-marker-alt text-indigo-500 mr-2"></i>
                                ${dayData.dayName}${dayData.city ? ' • ' + dayData.city : ''}
                            </h4>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-hotel text-gray-400 mr-2"></i>
                                ${data.hotelName}
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                            ${data.photos.map(photo => `
                                <div class="relative group bg-white rounded-lg overflow-hidden aspect-square border border-gray-200">
                                    <img src="${photo.downloadURL}" 
                                         alt="${photo.fileName}" 
                                         class="w-full h-full object-cover cursor-pointer"
                                         data-day-id="${dayId}">
                                    
                                    <!-- Boutons d'action -->
                                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button class="download-photo-btn bg-blue-600 hover:bg-blue-700 text-white w-7 h-7 rounded-full flex items-center justify-center"
                                                data-url="${photo.downloadURL}"
                                                data-filename="${photo.fileName}"
                                                title="Télécharger">
                                            <i class="fas fa-download text-xs"></i>
                                        </button>
                                        <button class="delete-photo-btn bg-red-600 hover:bg-red-700 text-white w-7 h-7 rounded-full flex items-center justify-center"
                                                data-id="${photo.id}"
                                                data-path="${photo.storagePath}"
                                                title="Supprimer">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-3 text-right">
                            ${data.photos.length} photo${data.photos.length > 1 ? 's' : ''}
                        </p>
                    `;
                    
                    listContainer.appendChild(hotelSection);
                }
                
                // Ajoute les listeners
                document.querySelectorAll('.download-photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        downloadPhoto(btn.dataset.url, btn.dataset.filename);
                    });
                });
                
                document.querySelectorAll('.delete-photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deletePhoto(btn.dataset.id, btn.dataset.path, 'hotel');
                    });
                });
                
                // Listener pour ouvrir la lightbox
                document.querySelectorAll('[data-day-id]').forEach(img => {
                    if (img.tagName === 'IMG') {
                        img.addEventListener('click', () => {
                            openHotelLightbox(img.dataset.dayId);
                        });
                    }
                });
                
            } catch (error) {
                console.error("Erreur lors du chargement des photos d'hôtels:", error);
                listContainer.innerHTML = '<p class="text-center text-red-500">Erreur de chargement</p>';
            }
        }

        /**
         * Compte les photos d'un hôtel (pour afficher le badge)
         */
        async function countHotelPhotos(dayId) {
            try {
                const mediaQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                    where('type', '==', 'hotel'),
                    where('linkedDayId', '==', dayId)
                );
                
                const snapshot = await getDocs(mediaQuery);
                const count = snapshot.size;
                
                // Mise en cache
                hotelPhotoCounts[dayId] = count;
                
                return count;
            } catch (error) {
                console.error("Erreur lors du comptage des photos:", error);
                return 0;
            }
        }

        /**
         * Ouvre la lightbox pour les photos d'un hôtel spécifique
         */
        async function openHotelLightbox(dayId) {
            try {
                // Récupère les infos de l'étape
                const dayDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/days/${dayId}`));
                if (!dayDoc.exists()) {
                    showToast("Étape introuvable.", "error");
                    return;
                }
                
                const dayData = dayDoc.data();
                
                // Récupère les photos
                const mediaQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`),
                    where('type', '==', 'hotel'),
                    where('linkedDayId', '==', dayId),
                    orderBy('uploadedAt', 'asc')
                );
                
                const snapshot = await getDocs(mediaQuery);
                
                if (snapshot.empty) {
                    showToast("Aucune photo pour cet hôtel.", "error");
                    return;
                }
                
                currentLightboxPhotos = [];
                snapshot.forEach(doc => {
                    currentLightboxPhotos.push({ id: doc.id, ...doc.data() });
                });
                
                currentLightboxIndex = 0;
                
                // Met à jour l'en-tête
                document.getElementById('lightbox-hotel-name').textContent = dayData.hotelName;
                document.getElementById('lightbox-day-name').textContent = `${dayData.dayName}${dayData.city ? ' • ' + dayData.city : ''}`;
                
                // Affiche la première photo
                updateLightboxDisplay();
                
                // Ouvre la modale
                toggleModal(document.getElementById('hotel-lightbox-modal'), true);
                
            } catch (error) {
                console.error("Erreur lors de l'ouverture de la lightbox:", error);
                showToast("Erreur lors du chargement des photos.", "error");
            }
        }

        /**
         * Met à jour l'affichage de la lightbox
         */
        function updateLightboxDisplay() {
            const currentPhoto = currentLightboxPhotos[currentLightboxIndex];
            
            // Image principale
            document.getElementById('lightbox-main-image').src = currentPhoto.downloadURL;
            
            // Compteur
            document.getElementById('lightbox-current-index').textContent = currentLightboxIndex + 1;
            document.getElementById('lightbox-total-count').textContent = currentLightboxPhotos.length;
            
            // Miniatures
            const thumbnailsContainer = document.getElementById('lightbox-thumbnails');
            thumbnailsContainer.innerHTML = '';
            
            currentLightboxPhotos.forEach((photo, index) => {
                const thumb = document.createElement('img');
                thumb.src = photo.downloadURL;
                thumb.alt = photo.fileName;
                thumb.className = `w-20 h-20 object-cover rounded cursor-pointer border-2 transition-all ${
                    index === currentLightboxIndex ? 'border-purple-600 opacity-100' : 'border-transparent opacity-60 hover:opacity-100'
                }`;
                thumb.addEventListener('click', () => {
                    currentLightboxIndex = index;
                    updateLightboxDisplay();
                });
                thumbnailsContainer.appendChild(thumb);
            });
            
            // Bouton download
            const downloadBtn = document.getElementById('lightbox-download-btn');
            downloadBtn.onclick = () => downloadPhoto(currentPhoto.downloadURL, currentPhoto.fileName);
            
            // Gère la visibilité des boutons de navigation
            document.getElementById('lightbox-prev-btn').style.display = 
                currentLightboxPhotos.length > 1 ? 'flex' : 'none';
            document.getElementById('lightbox-next-btn').style.display = 
                currentLightboxPhotos.length > 1 ? 'flex' : 'none';
        }

        /**
         * Navigation précédent dans la lightbox
         */
        function lightboxPrev() {
            if (currentLightboxIndex > 0) {
                currentLightboxIndex--;
                updateLightboxDisplay();
            } else {
                // Boucle vers la fin
                currentLightboxIndex = currentLightboxPhotos.length - 1;
                updateLightboxDisplay();
            }
        }

        /**
         * Navigation suivant dans la lightbox
         */
        function lightboxNext() {
            if (currentLightboxIndex < currentLightboxPhotos.length - 1) {
                currentLightboxIndex++;
                updateLightboxDisplay();
            } else {
                // Boucle vers le début
                currentLightboxIndex = 0;
                updateLightboxDisplay();
            }
        }

        /**
         * Télécharge une photo
         */
        async function downloadPhoto(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
                showToast("Photo téléchargée !", "success");
            } catch (error) {
                console.error("Erreur lors du téléchargement:", error);
                showToast("Erreur lors du téléchargement.", "error");
            }
        }

        /**
         * Supprime une photo
         */
        async function deletePhoto(mediaId, storagePath, type) {
            showDeleteConfirm("Voulez-vous vraiment supprimer cette photo ?", async () => {
                try {
                    // Supprime de Storage
                    const storageRef = ref(storage, storagePath);
                    await deleteObject(storageRef);
                    
                    // Supprime de Firestore
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media/${mediaId}`));
                    
                    showToast("Photo supprimée.", "success");
                    
                    // Recharge l'affichage
                    if (type === 'general') {
                        loadGeneralPhotos();
                        loadPopularTags();
                    } else {
                        loadHotelPhotos();
                        loadDays(); // Pour mettre à jour les badges
                    }
                    
                    updateSpaceMonitoring();
                    
                } catch (error) {
                    console.error("Erreur lors de la suppression:", error);
                    showToast("Erreur lors de la suppression.", "error");
                }
            });
        }

        /**
         * Met à jour le monitoring de l'espace utilisé
         */
        async function updateSpaceMonitoring() {
            try {
                const mediaQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/trips/${currentTripId}/media`)
                );
                
                const snapshot = await getDocs(mediaQuery);
                
                let totalSizeGeneral = 0;
                let totalSizeHotels = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.type === 'general') {
                        totalSizeGeneral += data.fileSize || 0;
                    } else {
                        totalSizeHotels += data.fileSize || 0;
                    }
                });
                
                // Conversion en MB
                const totalMBGeneral = (totalSizeGeneral / (1024 * 1024)).toFixed(2);
                const totalMBHotels = (totalSizeHotels / (1024 * 1024)).toFixed(2);
                const totalGB = 5;
                
                // Pourcentage
                const percentGeneral = (totalSizeGeneral / (totalGB * 1024 * 1024 * 1024)) * 100;
                const percentHotels = (totalSizeHotels / (totalGB * 1024 * 1024 * 1024)) * 100;
                
                // Mise à jour de l'affichage
                document.getElementById('space-used-general').textContent = totalMBGeneral + ' MB';
                document.getElementById('space-bar-general').style.width = Math.min(percentGeneral, 100) + '%';
                
                document.getElementById('space-used-hotels').textContent = totalMBHotels + ' MB';
                document.getElementById('space-bar-hotels').style.width = Math.min(percentHotels, 100) + '%';
                
            } catch (error) {
                console.error("Erreur lors du calcul de l'espace:", error);
            }
        }

        /**
         * Recherche dans les tags (avec debounce)
         */
        let searchTagsTimeout = null;
        function handleSearchTags(event) {
            const searchTerm = event.target.value.trim();
            
            if (searchTagsTimeout) {
                clearTimeout(searchTagsTimeout);
            }
            
            searchTagsTimeout = setTimeout(() => {
                if (searchTerm) {
                    loadGeneralPhotos(searchTerm);
                } else {
                    loadGeneralPhotos();
                }
            }, 300);
        }

        /**
         * Recherche dans les hôtels (avec debounce)
         */
        let searchHotelsTimeout = null;
        function handleSearchHotels(event) {
            const searchTerm = event.target.value.trim();
            
            if (searchHotelsTimeout) {
                clearTimeout(searchHotelsTimeout);
            }
            
            searchHotelsTimeout = setTimeout(() => {
                if (searchTerm) {
                    loadHotelPhotos(searchTerm);
                } else {
                    loadHotelPhotos();
                }
            }, 300);
        }

        // ============================================
        // LISTENERS POUR LE SYSTÈME DE MÉDIAS
        // ============================================

        // Bouton principal "Médias"
        document.getElementById('manage-media-btn').addEventListener('click', openMediaManager);

        // Fermeture de la modale principale
        document.getElementById('close-media-manager-btn').addEventListener('click', () => {
            toggleModal(document.getElementById('media-manager-modal'), false);
        });

        // Onglets
        document.getElementById('tab-general-btn').addEventListener('click', () => switchTab('general'));
        document.getElementById('tab-hotels-btn').addEventListener('click', () => switchTab('hotels'));

        // Upload général
        document.getElementById('upload-general-btn').addEventListener('click', handleGeneralUploadClick);
        document.getElementById('upload-general-input').addEventListener('change', handleGeneralFilesSelected);
        document.getElementById('confirm-upload-general-btn').addEventListener('click', confirmGeneralUpload);
        document.getElementById('cancel-tagging-btn').addEventListener('click', () => {
            toggleModal(document.getElementById('tagging-modal'), false);
            selectedFilesGeneral = [];
            document.getElementById('upload-general-input').value = '';
        });

        // Upload hôtel
        document.getElementById('upload-hotel-btn').addEventListener('click', handleHotelUploadClick);
        document.getElementById('upload-hotel-input').addEventListener('change', handleHotelFilesSelected);
        document.getElementById('confirm-upload-hotel-btn').addEventListener('click', confirmHotelUpload);
        document.getElementById('cancel-hotel-selection-btn').addEventListener('click', () => {
            toggleModal(document.getElementById('hotel-selection-modal'), false);
            selectedFilesHotel = [];
            selectedHotelForUpload = null;
            document.getElementById('upload-hotel-input').value = '';
        });

        // Recherche
        document.getElementById('search-tags-input').addEventListener('input', handleSearchTags);
        document.getElementById('search-hotels-input').addEventListener('input', handleSearchHotels);

        // Lightbox
        document.getElementById('close-lightbox-btn').addEventListener('click', () => {
            toggleModal(document.getElementById('hotel-lightbox-modal'), false);
        });
        document.getElementById('lightbox-prev-btn').addEventListener('click', lightboxPrev);
        document.getElementById('lightbox-next-btn').addEventListener('click', lightboxNext);

        // Navigation clavier dans la lightbox
        document.addEventListener('keydown', (e) => {
            const lightboxModal = document.getElementById('hotel-lightbox-modal');
            if (!lightboxModal.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') {
                    lightboxPrev();
                } else if (e.key === 'ArrowRight') {
                    lightboxNext();
                } else if (e.key === 'Escape') {
                    toggleModal(lightboxModal, false);
                }
            }
        });

        // Fermeture des modales en cliquant sur le fond
        [
            'media-manager-modal',
            'tagging-modal',
            'hotel-selection-modal',
            'hotel-lightbox-modal'
        ].forEach(modalId => {
            const modal = document.getElementById(modalId);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    toggleModal(modal, false);
                }
            });
        });

        // Démarrage de l'application
        startApp();

    </script>
</body>
</html>
